<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Setlist Viewer - Ultraphonics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: {} } }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Shared Styles -->
    <link rel="stylesheet" href="setlist-shared.css">

    <style>
        /* --- Viewer-Specific Layout --- */
        .viewer-container { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 1fr; gap: 1.5rem; height: calc(100vh - 70px); padding: 1.5rem; max-width: 1600px; margin: 0 auto; }

        @media (max-width: 768px) {
            .viewer-container { display: block; padding: 0; height: auto; min-height: calc(100vh - 120px); }
            #view-area { position: relative; overflow: visible; inset: auto; height: auto; }
        }

        /* --- Viewer-Specific: Active File State (Blue) --- */
        .file-item { padding: 1rem; }
        .file-item.active { background: #172554; border-color: #3b82f6; color: #60a5fa; }

        /* --- Viewer-Specific: Song Item Styles (Read-Only) --- */
        .song-item { padding: 0.85rem 1rem; border-left: 4px solid #444; }
        .song-item.segue-active { border-left-color: #3b82f6; }

        /* --- Viewer-Specific: Blue Primary Button --- */
        .btn { text-decoration: none; }
        .btn-primary { background: #3b82f6; color: #121212; }
        .btn-primary:hover { background: #2563eb; }
    </style>
</head>
<body class="bg-[#121212]">
    
    <!-- Header -->
    <header class="h-[70px] px-4 md:px-6 border-b border-[#333] bg-[#1e1e1e] flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded flex items-center justify-center text-white font-bold flex-shrink-0">
                <i class="fas fa-eye text-sm"></i>
            </div>
            <div>
                <h1 class="text-base md:text-lg font-bold text-white tracking-wide">Viewer</h1>
                <p id="connection-status" class="text-[10px] md:text-xs text-gray-500 whitespace-nowrap">Checking...</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a href="setlist-builder.html" id="link-edit-mode" class="btn btn-secondary text-xs px-3 bg-[#1e3a8a] border border-blue-500 text-blue-200 hover:bg-[#1e40af]" title="Switch to Edit Mode">
                <i class="fas fa-edit"></i> <span class="hidden md:inline">Edit Mode</span>
            </a>
            <button onclick="openSettings()" class="btn btn-secondary text-xs px-3" title="Settings">
                <i class="fas fa-cog"></i>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-[#3b82f6] text-sm transition ml-2 p-2">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </header>

    <!-- Mobile Tabs -->
    <div class="md:hidden flex border-b border-[#333] bg-[#1e1e1e] h-[50px]">
        <button onclick="switchMobileTab('files')" id="tab-files" class="flex-1 text-sm font-bold text-[#3b82f6] border-b-2 border-[#3b82f6] transition-colors">
            <i class="fas fa-folder mr-2"></i>Files
        </button>
        <button onclick="switchMobileTab('view')" id="tab-view" class="flex-1 text-sm font-bold text-gray-500 border-b-2 border-transparent transition-colors">
            <i class="fas fa-list-ul mr-2"></i>Setlist 
        </button>
    </div>

    <!-- Main Content -->
    <main class="viewer-container">
        
        <!-- LEFT: File Browser -->
        <div class="panel" id="panel-files">
            <div class="panel-header">
                <!-- Compact Header for Mobile -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-1">
                    <h2 class="font-bold text-white flex items-center gap-2 text-sm md:text-base"><i class="fas fa-folder-open text-[#3b82f6]"></i> <span class="md:inline hidden">Setlists</span><span class="md:hidden inline">Setlists</span></h2>
                    <div class="text-[10px] md:text-xs text-gray-500 font-mono truncate max-w-[150px] md:max-w-none" id="folder-path-display">...</div>
                </div>
            </div>
            
            <div id="file-list" class="scroll-area flex flex-col gap-2">
                <div class="text-center text-gray-500 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
            </div>
            
             <div class="p-3 border-t border-[#333]">
                <button onclick="fetchFiles()" class="btn btn-secondary w-full text-xs"><i class="fas fa-sync mr-2"></i> Refresh List</button>
            </div>
        </div>

        <!-- RIGHT: Viewer -->
        <div class="panel border-blue-900 border-opacity-30 mobile-hidden" id="panel-view">
            <div class="loading-overlay" id="main-loader">
                <div class="text-[#3b82f6] font-bold animate-pulse" id="loader-text"><i class="fas fa-sync fa-spin mr-2"></i> Loading...</div>
            </div>

            <div class="panel-header !flex-row !justify-between !items-center sticky top-0 bg-[#1e1e1e] z-10">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="font-bold text-lg text-white truncate" id="view-title">Select a Setlist</div>
                    <button id="btn-download" onclick="downloadCurrent()" class="text-gray-400 hover:text-[#3b82f6] hidden" title="Download JSON">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            
            <div class="relative flex-1 bg-[#181818] overflow-hidden" id="view-area-container">
                <div id="view-area" class="absolute inset-0 overflow-y-auto p-4 custom-scrollbar pb-20">
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="fas fa-arrow-left text-4xl mb-4 opacity-20 md:hidden"></i>
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-20 hidden md:block"></i>
                        <p>Select a file to view</p>
                    </div>
                </div>
            </div>

            <!-- Footer Stats (Moved from Header) -->
            <div class="bg-[#252525] p-2 px-4 border-t border-[#333] flex justify-between items-center text-[10px] text-gray-500 z-20">
                 <span id="view-stats" class="text-gray-300 font-mono text-xs overflow-hidden text-ellipsis whitespace-nowrap">0 items</span>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Settings</h2>
            <div class="form-group">
                <label class="form-label">GitHub Username / Owner</label>
                <input type="text" id="gh-owner" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Repository Name</label>
                <input type="text" id="gh-repo" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Personal Access Token (Requires 'repo' scope)</label>
                <input type="password" id="gh-token" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Setlists Folder</label>
                <input type="text" id="gh-path" class="form-input">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveSettings()" class="btn btn-primary">Save Config</button>
            </div>
        </div>
    </div>

    <!-- SHARED SCRIPT -->
    <script src="setlist-builder.js"></script>

    <script>
        // --- PAGE LOGIC ---
        const els = {
            files: document.getElementById('file-list'),
            viewArea: document.getElementById('view-area'),
            title: document.getElementById('view-title'),
            stats: document.getElementById('view-stats'),
            folderPath: document.getElementById('folder-path-display'),
            panels: { files: document.getElementById('panel-files'), view: document.getElementById('panel-view') },
            tabs: { files: document.getElementById('tab-files'), view: document.getElementById('tab-view') }
        };

        let currentSetlist = [];
        let currentFileObj = null;

        document.addEventListener('DOMContentLoaded', () => {
            const hasConfig = loadConfig();
            if (hasConfig) fetchFiles();
            else openSettings();
        });

        // --- FETCHING ---
        async function fetchFiles() {
            els.files.innerHTML = '<div class="text-center text-gray-500 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Fetching...</div>';
            els.folderPath.textContent = window.AppState.config.folder;
            
            try {
                const files = await fetchGithubFiles();
                renderFileList(files);
                
                // NEW: Auto-load file from URL params
                const urlParams = new URLSearchParams(window.location.search);
                const fileParam = urlParams.get('file');
                if (fileParam) {
                    const fileObj = files.find(f => f.name === fileParam);
                    if (fileObj) {
                        const fileEl = Array.from(els.files.children).find(el => el.textContent.includes(fileParam));
                        loadFile(fileObj, fileEl);
                    }
                }
            } catch (err) {
                els.files.innerHTML = `<div class="text-center text-red-500 mt-4 px-4">Error: ${err.message}<br><button onclick="openSettings()" class="underline mt-2">Check Settings</button></div>`;
            }
        }

        function renderFileList(files) {
            els.files.innerHTML = '';
            if (files.length === 0) {
                els.files.innerHTML = '<div class="text-center text-gray-500 mt-4">No setlists found.</div>';
                return;
            }
            
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `<div class="font-medium text-gray-200 truncate"><i class="fas fa-file-alt mr-2 text-gray-500"></i> ${file.name.replace('.json', '').replace('_', ' ')}</div>`;
                div.onclick = () => loadFile(file, div);
                els.files.appendChild(div);
            });
        }

        async function loadFile(fileObj, itemEl) {
            // Highlight active
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            if(itemEl) itemEl.classList.add('active');

            showLoader('main-loader', 'loader-text', true, `Loading ${fileObj.name}...`);
            if(window.innerWidth < 768) switchMobileTab('view');

            try {
                const data = await fetchGithubFileContent(fileObj.download_url);
                // Parse tags into properties for display
                const parsedData = parseSetlistFromImport(data);
                currentSetlist = parsedData;
                currentFileObj = fileObj;

                els.title.textContent = fileObj.name.replace('.json', '').replace('_', ' ');

                // Update Edit Mode Link to pass this file
                document.getElementById('link-edit-mode').href = `setlist-builder.html?file=${encodeURIComponent(fileObj.name)}`;

                // Show download button
                document.getElementById('btn-download').classList.remove('hidden');

                renderSetlist(parsedData);
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                showLoader('main-loader', null, false);
            }
        }

        function renderSetlist(data) {
            els.viewArea.innerHTML = '';
            els.stats.textContent = generateStats(data);
            
            if (!Array.isArray(data) || data.length === 0) {
                 els.viewArea.innerHTML = '<div class="text-center text-gray-500 mt-10">Empty Setlist</div>';
                 return;
            }

            data.forEach((song, index) => {
                const isSet = song.lastKnownName.toLowerCase().startsWith('set');
                const isSegue = (song.stop === false);
                const nextIsSet = data[index+1] && data[index+1].lastKnownName.toLowerCase().startsWith('set');
                
                const div = document.createElement('div');
                div.className = 'song-item';
                div.setAttribute('data-name', song.lastKnownName);
                
                // Visual Indicator for Segue
                if (isSegue && !isSet) div.classList.add('segue-active');
                
                let icon = '';
                if (isSegue) icon = '<i class="fas fa-arrow-down text-xs text-[#3b82f6] ml-2" title="Segue into next"></i>';
                if (isSet) icon = '';

                // --- Indicators Logic ---
                let indicatorsHtml = '';
                if (!isSet) {
                    // Eb
                    if (song.eflat) indicatorsHtml += `<span class="prop-label eflat" title="Eb Tuning">Eb</span>`;
                    // Drop
                    if (song.drop) indicatorsHtml += `<span class="prop-label drop" title="Drop Tuning">D</span>`;
                    // Capo
                    if (song.capo && song.capo > 0) indicatorsHtml += `<span class="prop-label capo" title="Capo ${song.capo}">C${song.capo}</span>`;
                    // Vocals
                    if (song.vocals) {
                        const v = song.vocals.toLowerCase();
                        const initial = song.vocals.charAt(0).toUpperCase();
                        indicatorsHtml += `<span class="prop-bubble ${v}" title="${song.vocals}">${initial}</span>`;
                    }
                }

                div.innerHTML = `
                    <div class="flex-1 overflow-hidden flex flex-col">
                        <div class="song-name text-lg ${isSet ? '' : 'text-gray-200'}">${song.lastKnownName}</div>
                    </div>
                    <div class="flex items-center">
                        <div class="flex items-center mr-2">${indicatorsHtml}</div>
                        <div>${icon}</div>
                    </div>
                `;
                els.viewArea.appendChild(div);
            });
        }

        function downloadCurrent() {
            if(!currentSetlist || !currentFileObj) return;
            // Prepare setlist with props stringified into notes
            const exportData = prepareSetlistForExport(currentSetlist);
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentFileObj.name;
            a.click();
        }

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('gh-owner').value = window.AppState.config.owner;
            document.getElementById('gh-repo').value = window.AppState.config.repo;
            document.getElementById('gh-token').value = window.AppState.config.token;
            document.getElementById('gh-path').value = window.AppState.config.folder;
            document.getElementById('settings-modal').classList.add('active');
        }

        function saveSettings() {
            if(saveSettingsFromUI('gh-owner', 'gh-repo', 'gh-token', 'gh-path', 'settings-modal')) {
                fetchFiles();
            }
        }

        // --- MOBILE TABS ---
        window.switchMobileTab = (tab) => {
            if (tab === 'files') {
                els.panels.files.classList.remove('mobile-hidden');
                els.panels.view.classList.add('mobile-hidden');
                els.tabs.files.classList.replace('text-gray-500', 'text-[#3b82f6]');
                els.tabs.files.classList.replace('border-transparent', 'border-[#3b82f6]');
                els.tabs.view.classList.replace('text-[#3b82f6]', 'text-gray-500');
                els.tabs.view.classList.replace('border-[#3b82f6]', 'border-transparent');
            } else {
                els.panels.files.classList.add('mobile-hidden');
                els.panels.view.classList.remove('mobile-hidden');
                els.tabs.view.classList.replace('text-gray-500', 'text-[#3b82f6]');
                els.tabs.view.classList.replace('border-transparent', 'border-[#3b82f6]');
                els.tabs.files.classList.replace('text-[#3b82f6]', 'text-gray-500');
                els.tabs.files.classList.replace('border-[#3b82f6]', 'border-transparent');
            }
        };
    </script>
</body>
</html>