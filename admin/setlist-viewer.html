<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Setlist Viewer - Ultraphonics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: {} } }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Reusing themes from builder for consistency */
        body { background-color: #121212; color: #e0e0e0; font-family: "Inter", system-ui, sans-serif; overflow: hidden; touch-action: pan-x pan-y; }
        
        .viewer-container { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 1fr; gap: 1.5rem; height: calc(100vh - 70px); padding: 1.5rem; max-width: 1600px; margin: 0 auto; }
        @media (max-width: 768px) { .viewer-container { display: block; padding: 0; height: calc(100vh - 120px); } }

        .panel { background: #1e1e1e; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.5); overflow: hidden; height: 100%; }
        @media (max-width: 768px) { .panel { border-radius: 0; border: none; } .mobile-hidden { display: none !important; } }

        .panel-header { padding: 1rem; background: #252525; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 0.75rem; flex-shrink: 0; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 0.75rem; scrollbar-width: thin; scrollbar-color: #444 #1e1e1e; -webkit-overflow-scrolling: touch; }

        /* File List Items */
        .file-item { padding: 1rem; background: #2a2a2a; margin-bottom: 0.5rem; border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .file-item:hover { background: #333; border-color: #444; }
        .file-item.active { background: #2c0b0e; border-color: #f87171; color: #fca5a5; }

        /* Song Items (Read Only) */
        .song-item { padding: 0.85rem 1rem; background: #2a2a2a; margin-bottom: 0.5rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #444; }
        .song-item.segue-active { border-left-color: #00ddde; } /* Segue indicator */
        .song-item[data-name^="Set"] { background: linear-gradient(90deg, #2c0b0e 0%, #1e1e1e 100%); border-left: 4px solid #f87171; margin: 1.5rem 0 1rem 0; }
        .song-item[data-name^="Set"] .song-name { font-weight: 700; font-size: 1.2em; color: #fca5a5; text-transform: uppercase; }

        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: none; transition: all 0.2s; white-space: nowrap; justify-content: center; text-decoration: none; }
        .btn-secondary { background: #333; color: #e0e0e0; }
        .btn-secondary:hover { background: #444; }
        .btn-primary { background: #00ddde; color: #121212; }
        .btn-primary:hover { background: #00b8b9; }

        /* --- Loader --- */
        .loading-overlay { position: absolute; inset: 0; background: rgba(30,30,30,0.9); display: none; align-items: center; justify-content: center; z-index: 20; }
        .loading-overlay.active { display: flex; }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #aaa; }
        .form-input { width: 100%; padding: 0.75rem; background: #121212; border: 1px solid #333; color: white; border-radius: 6px; margin-bottom: 1rem; }
        
         /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1e1e1e; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid #444; max-height: 85vh; display: flex; flex-direction: column; }
    </style>
</head>
<body class="bg-[#121212]">
    
    <!-- Header -->
    <header class="h-[70px] px-4 md:px-6 border-b border-[#333] bg-[#1e1e1e] flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded flex items-center justify-center text-white font-bold flex-shrink-0">V</div>
            <div>
                <h1 class="text-base md:text-lg font-bold text-white tracking-wide">Viewer</h1>
                <p id="connection-status" class="text-[10px] md:text-xs text-gray-500 whitespace-nowrap">Checking...</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a href="setlist-builder.html" class="btn btn-secondary text-xs px-3 bg-[#1e3a8a] border border-blue-500 text-blue-200 hover:bg-[#1e40af]" title="Switch to Edit Mode">
                <i class="fas fa-edit"></i> <span class="hidden md:inline">Edit Mode</span>
            </a>
            <button onclick="openSettings()" class="btn btn-secondary text-xs px-3">
                <i class="fas fa-cog"></i>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-[#00ddde] text-sm transition ml-2 p-2">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </header>

    <!-- Mobile Tabs -->
    <div class="md:hidden flex border-b border-[#333] bg-[#1e1e1e] h-[50px]">
        <button onclick="switchMobileTab('files')" id="tab-files" class="flex-1 text-sm font-bold text-[#00ddde] border-b-2 border-[#00ddde] transition-colors">
            <i class="fas fa-folder mr-2"></i>Files
        </button>
        <button onclick="switchMobileTab('view')" id="tab-view" class="flex-1 text-sm font-bold text-gray-500 border-b-2 border-transparent transition-colors">
            <i class="fas fa-list-ul mr-2"></i>Setlist 
        </button>
    </div>

    <!-- Main Content -->
    <main class="viewer-container">
        
        <!-- LEFT: File Browser -->
        <div class="panel" id="panel-files">
            <div class="panel-header">
                <h2 class="font-bold text-white flex items-center gap-2"><i class="fas fa-folder-open text-[#00ddde]"></i> Available Setlists</h2>
                <div class="text-xs text-gray-500 mt-1" id="folder-path-display">...</div>
            </div>
            
            <div id="file-list" class="scroll-area flex flex-col gap-2">
                <div class="text-center text-gray-500 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
            </div>
            
             <div class="p-3 border-t border-[#333]">
                <button onclick="fetchFiles()" class="btn btn-secondary w-full text-xs"><i class="fas fa-sync mr-2"></i> Refresh List</button>
            </div>
        </div>

        <!-- RIGHT: Viewer -->
        <div class="panel border-purple-900 border-opacity-30 mobile-hidden" id="panel-view">
            <div class="loading-overlay" id="main-loader">
                <div class="text-[#00ddde] font-bold animate-pulse" id="loader-text"><i class="fas fa-sync fa-spin mr-2"></i> Loading...</div>
            </div>

            <div class="panel-header !flex-row !justify-between !items-center">
                <div class="font-bold text-lg text-white truncate" id="view-title">Select a Setlist</div>
                <div class="text-xs font-mono text-[#00ddde] bg-[#222] px-2 py-1 rounded" id="view-stats"></div>
            </div>
            
            <div class="relative flex-1 bg-[#181818] overflow-hidden">
                <div id="view-area" class="absolute inset-0 overflow-y-auto p-4 custom-scrollbar pb-20">
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="fas fa-arrow-left text-4xl mb-4 opacity-20 md:hidden"></i>
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-20 hidden md:block"></i>
                        <p>Select a file to view</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Settings</h2>
            <div class="form-group">
                <label class="form-label">GitHub Username / Owner</label>
                <input type="text" id="gh-owner" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Repository Name</label>
                <input type="text" id="gh-repo" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Personal Access Token (Requires 'repo' scope)</label>
                <input type="password" id="gh-token" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Setlists Folder</label>
                <input type="text" id="gh-path" class="form-input">
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveSettings()" class="btn btn-primary">Save Config</button>
            </div>
        </div>
    </div>

    <!-- SHARED SCRIPT -->
    <script src="setlist-builder.js"></script>

    <script>
        // --- PAGE LOGIC ---
        const els = {
            files: document.getElementById('file-list'),
            viewArea: document.getElementById('view-area'),
            title: document.getElementById('view-title'),
            stats: document.getElementById('view-stats'),
            folderPath: document.getElementById('folder-path-display'),
            panels: { files: document.getElementById('panel-files'), view: document.getElementById('panel-view') },
            tabs: { files: document.getElementById('tab-files'), view: document.getElementById('tab-view') }
        };

        let currentSetlist = [];

        document.addEventListener('DOMContentLoaded', () => {
            const hasConfig = loadConfig();
            if (hasConfig) fetchFiles();
            else openSettings();
        });

        // --- FETCHING ---
        async function fetchFiles() {
            els.files.innerHTML = '<div class="text-center text-gray-500 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Fetching...</div>';
            els.folderPath.textContent = window.AppState.config.folder;
            
            try {
                const files = await fetchGithubFiles();
                renderFileList(files);
            } catch (err) {
                els.files.innerHTML = `<div class="text-center text-red-500 mt-4 px-4">Error: ${err.message}<br><button onclick="openSettings()" class="underline mt-2">Check Settings</button></div>`;
            }
        }

        function renderFileList(files) {
            els.files.innerHTML = '';
            if (files.length === 0) {
                els.files.innerHTML = '<div class="text-center text-gray-500 mt-4">No setlists found.</div>';
                return;
            }
            
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `<div class="font-medium text-gray-200 truncate"><i class="fas fa-file-alt mr-2 text-gray-500"></i> ${file.name}</div>`;
                div.onclick = () => loadFile(file, div);
                els.files.appendChild(div);
            });
        }

        async function loadFile(fileObj, itemEl) {
            // Highlight active
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            if(itemEl) itemEl.classList.add('active');

            showLoader('main-loader', 'loader-text', true, `Loading ${fileObj.name}...`);
            if(window.innerWidth < 768) switchMobileTab('view');
            
            try {
                const data = await fetchGithubFileContent(fileObj.download_url);
                currentSetlist = data;
                els.title.textContent = fileObj.name.replace('.json', '');
                renderSetlist(data);
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                showLoader('main-loader', null, false);
            }
        }

        function renderSetlist(data) {
            els.viewArea.innerHTML = '';
            els.stats.textContent = generateStats(data);
            
            if (!Array.isArray(data) || data.length === 0) {
                 els.viewArea.innerHTML = '<div class="text-center text-gray-500 mt-10">Empty Setlist</div>';
                 return;
            }

            data.forEach((song, index) => {
                const isSet = song.lastKnownName.toLowerCase().startsWith('set');
                const isSegue = (song.stop === false);
                const nextIsSet = data[index+1] && data[index+1].lastKnownName.toLowerCase().startsWith('set');
                
                const div = document.createElement('div');
                div.className = 'song-item';
                div.setAttribute('data-name', song.lastKnownName);
                
                // Visual Indicator for Segue (Green/Blue line on left vs standard gray)
                // If it's a Set marker, red line.
                // If Segue is active (stop=false), make border bright.
                if (isSegue && !isSet) div.classList.add('segue-active');
                
                let icon = '<i class="fas fa-stop text-xs text-gray-600 ml-2" title="Stop after this"></i>';
                if (isSegue) icon = '<i class="fas fa-arrow-down text-xs text-[#00ddde] ml-2" title="Segue into next"></i>';
                if (isSet) icon = '';

                div.innerHTML = `
                    <div class="song-name text-lg ${isSet ? '' : 'text-gray-200'}">${song.lastKnownName}</div>
                    <div>${icon}</div>
                `;
                els.viewArea.appendChild(div);
            });
        }

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('gh-owner').value = window.AppState.config.owner;
            document.getElementById('gh-repo').value = window.AppState.config.repo;
            document.getElementById('gh-token').value = window.AppState.config.token;
            document.getElementById('gh-path').value = window.AppState.config.folder;
            document.getElementById('settings-modal').classList.add('active');
        }

        function saveSettings() {
            if(saveSettingsFromUI('gh-owner', 'gh-repo', 'gh-token', 'gh-path', 'settings-modal')) {
                fetchFiles();
            }
        }

        // --- MOBILE TABS ---
        window.switchMobileTab = (tab) => {
            if (tab === 'files') {
                els.panels.files.classList.remove('mobile-hidden');
                els.panels.view.classList.add('mobile-hidden');
                els.tabs.files.classList.replace('text-gray-500', 'text-[#00ddde]');
                els.tabs.files.classList.replace('border-transparent', 'border-[#00ddde]');
                els.tabs.view.classList.replace('text-[#00ddde]', 'text-gray-500');
                els.tabs.view.classList.replace('border-[#00ddde]', 'border-transparent');
            } else {
                els.panels.files.classList.add('mobile-hidden');
                els.panels.view.classList.remove('mobile-hidden');
                els.tabs.view.classList.replace('text-gray-500', 'text-[#00ddde]');
                els.tabs.view.classList.replace('border-transparent', 'border-[#00ddde]');
                els.tabs.files.classList.replace('text-[#00ddde]', 'text-gray-500');
                els.tabs.files.classList.replace('border-[#00ddde]', 'border-transparent');
            }
        };
    </script>
</body>
</html>