<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Setlist Viewer - Ultraphonics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: {} } }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Shared Styles -->
    <link rel="stylesheet" href="setlist-shared.css">

    <style>
        /* --- Viewer-Specific Layout --- */
        /* Ensure body can scroll */
        body {
            overflow-y: auto !important;
            height: auto !important;
        }

        .viewer-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1.5rem;
            padding-bottom: 80px; /* Space for stats bar */
            min-height: calc(100vh - 70px);
        }

        @media (max-width: 768px) {
            .viewer-container {
                padding: 0;
                padding-bottom: 80px; /* Space for stats bar */
            }
        }

        /* Sticky header */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* Sticky tabs */
        .tabs-container {
            position: sticky;
            top: 70px; /* Height of header */
            z-index: 40;
            background: #1e1e1e;
        }

        /* Fixed stats bar at bottom */
        .stats-bar-mobile {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        /* --- Viewer-Specific: Active File State (Blue) --- */
        .file-item { padding: 1rem; }
        .file-item.active { background: #172554; border-color: #3b82f6; color: #60a5fa; }

        /* --- Viewer-Specific: Song Item Styles (Read-Only) --- */
        .song-item { padding: 0.85rem 1rem; border-left: 4px solid #444; }
        .song-item.segue-active { border-left-color: #3b82f6; }

        /* --- Viewer-Specific: Blue Primary Button --- */
        .btn { text-decoration: none; }
        .btn-primary { background: #3b82f6; color: #121212; }
        .btn-primary:hover { background: #2563eb; }
    </style>
</head>
<body class="bg-[#121212]">
    
    <!-- Header -->
    <header class="h-[70px] px-4 md:px-6 border-b border-[#333] bg-[#1e1e1e] flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded flex items-center justify-center text-white font-bold flex-shrink-0">
                <i class="fas fa-eye text-sm"></i>
            </div>
            <div>
                <h1 class="text-base md:text-lg font-bold text-white tracking-wide">Viewer</h1>
                <p id="connection-status" class="text-[10px] md:text-xs text-gray-500 whitespace-nowrap">Checking...</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a href="setlist-builder.html" id="link-edit-mode" class="btn btn-secondary text-xs px-3 bg-[#1e3a8a] border border-blue-500 text-blue-200 hover:bg-[#1e40af]" title="Switch to Edit Mode">
                <i class="fas fa-edit"></i> <span class="hidden md:inline">Edit Mode</span>
            </a>
            <a id="headerAblesetLink" href="#" target="_blank" class="text-gray-400 hover:text-rose-400 transition-colors p-2 rounded-lg hover:bg-[#333]" title="Launch AbleSet">
                <i class="fas fa-circle-play"></i>
            </a>
            <button onclick="openSettings()" class="btn btn-secondary text-xs px-3" title="Settings">
                <i class="fas fa-cog"></i>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-[#3b82f6] text-sm transition ml-2 p-2">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="viewer-container">
        <div class="panel">
            <div class="loading-overlay" id="main-loader">
                <div class="text-[#3b82f6] font-bold animate-pulse" id="loader-text"><i class="fas fa-sync fa-spin mr-2"></i> Loading...</div>
            </div>

            <!-- Header with Title and Download -->
            <div class="panel-header !flex-row !justify-between !items-center">
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <div class="font-bold text-lg text-white truncate" id="view-title">Select a Setlist</div>
                    <button id="btn-download" onclick="downloadCurrent()" class="text-gray-400 hover:text-[#3b82f6] hidden" title="Download JSON">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- Tabs (Sets / Songs) - Sticky -->
            <div class="tabs-container">
                <div class="p-3 border-b border-[#333] bg-[#252525]">
                    <div class="flex bg-[#121212] p-1 rounded-lg">
                        <button onclick="switchTab('sets')" id="tab-sets" class="flex-1 py-2 text-sm font-bold rounded-md transition-all bg-[#333] text-[#3b82f6] shadow-sm">
                            <i class="fas fa-folder mr-2"></i>Sets
                        </button>
                        <button onclick="switchTab('songs')" id="tab-songs" class="flex-1 py-2 text-sm font-bold rounded-md transition-all text-gray-400 hover:text-white">
                            <i class="fas fa-list-ul mr-2"></i>Songs
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sets View -->
            <div id="view-sets">
                <div class="p-3 border-b border-[#333] flex justify-between items-center bg-[#252525]">
                    <span class="text-xs text-gray-400 font-mono truncate" id="folder-path-display">...</span>
                </div>
                <div id="file-list" class="flex flex-col gap-2 p-3">
                    <div class="text-center text-gray-500 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
                </div>
                <div class="p-3 border-t border-[#333]">
                    <button onclick="fetchFiles()" class="btn btn-secondary w-full text-sm"><i class="fas fa-sync mr-2"></i> Refresh List</button>
                </div>
            </div>

            <!-- Songs View -->
            <div id="view-songs" class="hidden">
                <div id="view-area" class="p-4 pb-20">
                    <div class="flex flex-col items-center justify-center text-gray-600 py-20">
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-20"></i>
                        <p>Select a setlist to view songs</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Stats - Fixed at bottom -->
    <div class="stats-bar-mobile bg-[#252525] p-2 px-4 border-t border-[#333] flex justify-center md:justify-between items-center">
        <span id="view-stats" class="text-[#3b82f6] font-mono text-sm overflow-hidden text-ellipsis whitespace-nowrap">0 items</span>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Settings</h2>

            <!-- GitHub Authentication -->
            <div class="form-group">
                <label class="form-label">GitHub Authentication</label>

                <!-- Helper link -->
                <a href="https://github.com/settings/tokens/new?description=Ultraphonics%20Setlist%20Builder&scopes=repo"
                   target="_blank"
                   class="block w-full btn btn-primary mb-2 text-center">
                    <i class="fab fa-github mr-2"></i> Create GitHub Token
                </a>
                <p class="text-gray-500 text-xs mb-3">
                    Opens GitHub with the token form pre-filled. Copy the token and paste below.
                </p>

                <!-- Token Input -->
                <label class="form-label text-sm">Personal Access Token</label>
                <input type="password" id="gh-token" class="form-input" placeholder="ghp_...">
                <p class="text-gray-500 text-xs mt-1">Optional - only needed for editing setlists</p>
            </div>

            <!-- AbleSet Settings -->
            <div class="form-group">
                <label class="form-label">AbleSet Host URL</label>
                <input type="text" id="ableset-url" class="form-input" placeholder="http://192.168.1.243">
                <p class="text-gray-500 text-xs mt-1">Example: http://192.168.1.243, http://Karls-MacBook.local</p>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveSettings()" class="btn btn-primary">Save Config</button>
            </div>
        </div>
    </div>

    <!-- SHARED SCRIPT -->
    <script src="setlist-builder.js"></script>

    <script>
        // --- PAGE LOGIC ---
        const els = {
            files: document.getElementById('file-list'),
            viewArea: document.getElementById('view-area'),
            title: document.getElementById('view-title'),
            stats: document.getElementById('view-stats'),
            folderPath: document.getElementById('folder-path-display'),
            tabs: { sets: document.getElementById('tab-sets'), songs: document.getElementById('tab-songs') },
            views: { sets: document.getElementById('view-sets'), songs: document.getElementById('view-songs') }
        };

        let currentSetlist = [];
        let currentFileObj = null;

        // --- ABLESET LINK UPDATE ---
        function updateAbleSetLink() {
            const DEFAULT_ABLESET_URL = 'http://192.168.1.243';
            const storedUrl = localStorage.getItem('ableset_url');
            const url = storedUrl || DEFAULT_ABLESET_URL;
            document.getElementById('headerAblesetLink').href = url;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hasConfig = loadConfig();
            updateAbleSetLink();
            if (hasConfig) fetchFiles();
            else openSettings();
        });

        // --- FETCHING ---
        async function fetchFiles() {
            els.files.innerHTML = '<div class="text-center text-gray-500 mt-10"><i class="fas fa-circle-notch fa-spin"></i> Fetching...</div>';
            els.folderPath.textContent = window.AppState.config.folder;
            
            try {
                const files = await fetchGithubFiles();
                renderFileList(files);
                
                // NEW: Auto-load file from URL params
                const urlParams = new URLSearchParams(window.location.search);
                const fileParam = urlParams.get('file');
                if (fileParam) {
                    const fileObj = files.find(f => f.name === fileParam);
                    if (fileObj) {
                        const fileEl = Array.from(els.files.children).find(el => el.textContent.includes(fileParam));
                        loadFile(fileObj, fileEl);
                    }
                }
            } catch (err) {
                els.files.innerHTML = `<div class="text-center text-red-500 mt-4 px-4">Error: ${err.message}<br><button onclick="openSettings()" class="underline mt-2">Check Settings</button></div>`;
            }
        }

        function renderFileList(files) {
            els.files.innerHTML = '';
            if (files.length === 0) {
                els.files.innerHTML = '<div class="text-center text-gray-500 mt-4">No setlists found.</div>';
                return;
            }
            
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `<div class="font-medium text-gray-200 truncate"><i class="fas fa-file-alt mr-2 text-gray-500"></i> ${file.name.replace('.json', '').replace('_', ' ')}</div>`;
                div.onclick = () => loadFile(file, div);
                els.files.appendChild(div);
            });
        }

        async function loadFile(fileObj, itemEl) {
            // Highlight active
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            if(itemEl) itemEl.classList.add('active');

            showLoader('main-loader', 'loader-text', true, `Loading ${fileObj.name}...`);

            // Update URL with file parameter for sharing
            const url = new URL(window.location);
            url.searchParams.set('file', fileObj.name);
            window.history.replaceState({}, '', url);

            try {
                const data = await fetchGithubFileContent(fileObj.download_url);
                // Parse tags into properties for display
                const parsedData = parseSetlistFromImport(data);
                currentSetlist = parsedData;
                currentFileObj = fileObj;

                els.title.textContent = fileObj.name.replace('.json', '').replace('_', ' ');

                // Update Edit Mode Link to pass this file
                document.getElementById('link-edit-mode').href = `setlist-builder.html?file=${encodeURIComponent(fileObj.name)}`;

                // Show download button
                document.getElementById('btn-download').classList.remove('hidden');

                renderSetlist(parsedData);

                // Switch to songs view after loading
                switchTab('songs');
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                showLoader('main-loader', null, false);
            }
        }

        function renderSetlist(data) {
            els.viewArea.innerHTML = '';
            els.stats.textContent = generateStats(data);

            if (!Array.isArray(data) || data.length === 0) {
                 els.viewArea.innerHTML = '<div class="text-center text-gray-500 mt-10">Empty Setlist</div>';
                 return;
            }

            data.forEach((song, index) => {
                const isSet = song.lastKnownName.toLowerCase().startsWith('set');
                const isSegue = (song.stop === false);
                const nextIsSet = data[index+1] && data[index+1].lastKnownName.toLowerCase().startsWith('set');

                const div = document.createElement('div');
                div.className = 'song-item';
                div.setAttribute('data-name', song.lastKnownName);

                // Visual Indicator for Segue
                if (isSegue && !isSet) div.classList.add('segue-active');

                let icon = '';
                if (isSegue) icon = '<i class="fas fa-arrow-down text-xs text-[#3b82f6] ml-2" title="Segue into next"></i>';
                if (isSet) icon = '';

                // --- Indicators Logic ---
                let indicatorsHtml = '';
                if (!isSet) {
                    // Eb
                    if (song.eflat) indicatorsHtml += `<span class="prop-label eflat" title="Eb Tuning">Eb</span>`;
                    // Drop
                    if (song.drop) indicatorsHtml += `<span class="prop-label drop" title="Drop Tuning">D</span>`;
                    // Capo
                    if (song.capo && song.capo > 0) indicatorsHtml += `<span class="prop-label capo" title="Capo ${song.capo}">C${song.capo}</span>`;
                    // Vocals
                    if (song.vocals) {
                        const v = song.vocals.toLowerCase();
                        const initial = song.vocals.charAt(0).toUpperCase();
                        indicatorsHtml += `<span class="prop-bubble ${v}" title="${song.vocals}">${initial}</span>`;
                    }
                }

                div.innerHTML = `
                    <div class="flex-1 overflow-hidden flex flex-col">
                        <div class="song-name text-lg ${isSet ? '' : 'text-gray-200'}">${song.lastKnownName}</div>
                    </div>
                    <div class="flex items-center">
                        <div class="flex items-center mr-2">${indicatorsHtml}</div>
                        <div>${icon}</div>
                    </div>
                `;
                els.viewArea.appendChild(div);
            });
        }

        function downloadCurrent() {
            if(!currentSetlist || !currentFileObj) return;
            // Prepare setlist with props stringified into notes
            const exportData = prepareSetlistForExport(currentSetlist);
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentFileObj.name;
            a.click();
        }

        // --- SETTINGS ---
        function openSettings() {
            // Load GitHub token
            document.getElementById('gh-token').value = window.AppState.config.token;

            // Load AbleSet URL
            const DEFAULT_ABLESET_URL = 'http://192.168.1.243';
            const storedUrl = localStorage.getItem('ableset_url');
            document.getElementById('ableset-url').value = storedUrl || DEFAULT_ABLESET_URL;

            document.getElementById('settings-modal').classList.add('active');
        }

        function saveSettings() {
            // Save GitHub token (keep other settings unchanged)
            const token = document.getElementById('gh-token').value.trim();
            window.AppState.config.token = token;
            localStorage.setItem('up_gh_config', JSON.stringify(window.AppState.config));
            updateConnectionStatus(!!(window.AppState.config.owner && window.AppState.config.repo));

            // Save AbleSet URL
            let ablesetUrl = document.getElementById('ableset-url').value.trim();
            if (!ablesetUrl) ablesetUrl = 'http://192.168.1.243';
            if (!ablesetUrl.startsWith('http://') && !ablesetUrl.startsWith('https://')) {
                ablesetUrl = 'http://' + ablesetUrl;
            }
            localStorage.setItem('ableset_url', ablesetUrl);

            updateAbleSetLink();
            document.getElementById('settings-modal').classList.remove('active');
            fetchFiles();
        }

        // --- TAB SWITCHING ---
        window.switchTab = (tab) => {
            if (tab === 'sets') {
                // Show sets view, hide songs
                els.views.sets.classList.remove('hidden');
                els.views.songs.classList.add('hidden');

                // Update tab button styling
                els.tabs.sets.classList.add('bg-[#333]', 'text-[#3b82f6]', 'shadow-sm');
                els.tabs.sets.classList.remove('text-gray-400', 'hover:text-white');
                els.tabs.songs.classList.remove('bg-[#333]', 'text-[#3b82f6]', 'shadow-sm');
                els.tabs.songs.classList.add('text-gray-400', 'hover:text-white');
            } else {
                // Show songs view, hide sets
                els.views.sets.classList.add('hidden');
                els.views.songs.classList.remove('hidden');

                // Update tab button styling
                els.tabs.songs.classList.add('bg-[#333]', 'text-[#3b82f6]', 'shadow-sm');
                els.tabs.songs.classList.remove('text-gray-400', 'hover:text-white');
                els.tabs.sets.classList.remove('bg-[#333]', 'text-[#3b82f6]', 'shadow-sm');
                els.tabs.sets.classList.add('text-gray-400', 'hover:text-white');
            }
        };
    </script>
</body>
</html>