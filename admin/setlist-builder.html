<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist Builder - Ultraphonics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning
        tailwind.config = {
            theme: { extend: {} }
        }
    </script>
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Base Theme --- */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            overflow: hidden;
        }

        /* --- Layout --- */
        .editor-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 1fr;
            gap: 1.5rem;
            height: calc(100vh - 70px);
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
                overflow-y: auto;
                height: auto;
            }
        }

        /* --- Panels --- */
        .panel {
            background: #1e1e1e;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            padding: 1rem;
            background: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: #444 #1e1e1e;
        }

        /* --- Song Cards --- */
        .song-item {
            padding: 0.75rem 1rem;
            background: #2a2a2a;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: transform 0.2s, background-color 0.2s;
            user-select: none;
            position: relative; /* Fix for z-index issues during drag */
        }

        .song-item:hover {
            background: #333;
            border-color: #444;
            transform: translateY(-1px);
        }

        /* Dragging Styles (Force Fallback) */
        .song-item.sortable-ghost {
            opacity: 0.4;
            background: #00ddde !important;
            border: 1px dashed #fff;
        }
        
        .song-item.sortable-drag {
            background: #00ddde !important;
            color: #121212 !important;
            opacity: 1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            transform: scale(1.02);
            cursor: grabbing;
        }
        
        /* Ensure text in drag clone is visible */
        .song-item.sortable-drag .song-name {
            color: #121212 !important;
        }

        /* Set Markers */
        .song-item[data-name^="Set"] {
            background: linear-gradient(90deg, #2c0b0e 0%, #1e1e1e 100%);
            border-left: 4px solid #f87171;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .song-item[data-name^="Set"] .song-name {
            font-weight: 700;
            font-size: 1.1em;
            color: #fca5a5;
            text-transform: uppercase;
        }

        /* --- Controls --- */
        .search-input {
            width: 100%;
            padding: 0.6rem 1rem;
            background: #121212;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .search-input:focus { outline: none; border-color: #00ddde; }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background: #00ddde; color: #121212; }
        .btn-primary:hover { background: #00b8b9; }
        .btn-secondary { background: #333; color: #e0e0e0; }
        .btn-secondary:hover { background: #444; }
        .btn-danger { background: #7f1d1d; color: #fca5a5; }
        .btn-danger:hover { background: #991b1b; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Segue Toggle --- */
        .segue-toggle { position: relative; display: none; width: 36px; height: 20px; }
        .segue-toggle input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #00ddde; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 50;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #1e1e1e; padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 500px; border: 1px solid #444;
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #aaa; }
        .form-input {
            width: 100%; padding: 0.75rem; background: #121212; border: 1px solid #333;
            color: white; border-radius: 6px;
        }
        
        /* File List in Modal */
        .file-list {
            display: flex; flex-direction: column; gap: 0.5rem;
            margin-top: 1rem; overflow-y: auto; flex: 1; min-height: 200px;
        }
        .file-item {
            padding: 0.75rem; background: #252525; border-radius: 6px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s;
        }
        .file-item:hover { background: #333; }
        .file-item.active { background: #2c0b0e; border: 1px solid #f87171; }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(30,30,30,0.9);
            display: none; align-items: center; justify-content: center; z-index: 20;
        }
        .loading-overlay.active { display: flex; }

    </style>
</head>
<body class="bg-[#121212]">
    
    <!-- Header -->
    <header class="h-[70px] px-6 border-b border-[#333] bg-[#1e1e1e] flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-[#00ddde] to-blue-600 rounded flex items-center justify-center text-black font-bold">U</div>
            <div>
                <h1 class="text-lg font-bold text-white tracking-wide">Setlist Builder</h1>
                <p id="connection-status" class="text-xs text-gray-500">
                    <i class="fas fa-circle text-[8px] mr-1"></i> Checking...
                </p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openSettings()" class="btn btn-secondary text-xs" title="GitHub Settings">
                <i class="fas fa-cog"></i> Settings
            </button>
            <a href="index.html" class="text-gray-400 hover:text-[#00ddde] text-sm transition ml-2">
                <i class="fas fa-arrow-left mr-1"></i> Exit
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="editor-container">
        
        <!-- LEFT PANEL: Master Library -->
        <div class="panel">
            <div class="panel-header">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold text-white flex items-center gap-2">
                        <i class="fas fa-music text-[#00ddde]"></i> Library
                    </h2>
                    <span id="library-count" class="text-xs font-mono text-gray-500 bg-[#121212] px-2 py-1 rounded">0</span>
                </div>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="search" placeholder="Search songs..." class="search-input pl-8">
                </div>
                <div class="flex gap-2 mt-1">
                    <button onclick="filterLibrary('all')" class="text-xs px-2 py-1 rounded bg-[#333] hover:bg-[#444] text-white transition">All</button>
                    <button onclick="filterLibrary('sets')" class="text-xs px-2 py-1 rounded bg-[#2c0b0e] text-[#fca5a5] border border-[#f87171] hover:opacity-80 transition">Sets</button>
                </div>
            </div>
            
            <div id="library-list" class="scroll-area">
                <div class="flex flex-col items-center justify-center h-40 text-gray-500">
                    <i class="fas fa-circle-notch fa-spin mb-2"></i> Loading Library...
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Current Setlist -->
        <div class="panel border-[#00ddde] border-opacity-30">
            <div class="loading-overlay" id="main-loader">
                <div class="text-[#00ddde] font-bold animate-pulse" id="loader-text"><i class="fas fa-sync fa-spin mr-2"></i> Processing...</div>
            </div>

            <!-- Toolbar -->
            <div class="panel-header !flex-row !justify-between !items-center !gap-4 !bg-[#181818]">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="font-bold text-white whitespace-nowrap">File:</div>
                    <div id="current-filename" class="text-[#00ddde] font-mono text-sm truncate px-2 py-1 bg-[#222] rounded border border-[#333]">
                        (Unsaved)
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="resetToNew()" class="btn btn-secondary" title="New Setlist">
                        <i class="fas fa-file"></i> <span class="hidden md:inline">New</span>
                    </button>
                    <button onclick="openFileManager()" class="btn btn-secondary" title="Open from GitHub" id="btn-open" disabled>
                        <i class="fas fa-folder-open"></i> <span class="hidden md:inline">Open</span>
                    </button>
                    <button onclick="saveCurrent()" class="btn btn-primary" id="btn-save" disabled>
                        <i class="fas fa-save"></i> <span class="hidden md:inline">Save</span>
                    </button>
                     <button onclick="saveAs()" class="btn btn-secondary" id="btn-save-as" disabled>
                        <i class="fas fa-copy"></i> <span class="hidden md:inline">Save As...</span>
                    </button>
                </div>
            </div>
            
            <!-- Wrapper for Setlist + Empty State Overlay -->
            <div class="relative flex-1 bg-[#181818] overflow-hidden">
                <!-- Sortable Container -->
                <div id="setlist-area" class="absolute inset-0 overflow-y-auto p-3 custom-scrollbar">
                    <!-- Songs dropped here -->
                </div>

                <!-- Empty State Overlay (Sibling, not child) -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 pointer-events-none z-10">
                    <i class="fas fa-hand-pointer text-4xl mb-4 opacity-20"></i>
                    <p class="font-medium opacity-50">Drag songs here</p>
                </div>
            </div>

            <!-- Footer Stats -->
            <div class="bg-[#252525] p-2 px-4 border-t border-[#333] flex justify-between items-center text-[10px] text-gray-500 z-20">
                <span id="setlist-stats" class="text-gray-300 font-mono text-xs overflow-hidden text-ellipsis whitespace-nowrap max-w-[70%]">0 items</span>
                <button onclick="downloadLocalJSON()" class="hover:text-[#00ddde] whitespace-nowrap">Download Backup</button>
            </div>
        </div>
    </main>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Settings</h2>
            <div class="form-group">
                <label class="form-label">GitHub Username / Owner</label>
                <input type="text" id="gh-owner" class="form-input" placeholder="e.g. tdhckmn">
            </div>
            <div class="form-group">
                <label class="form-label">Repository Name</label>
                <input type="text" id="gh-repo" class="form-input" placeholder="e.g. ultraphonics-web">
            </div>
            <div class="form-group">
                <label class="form-label">Personal Access Token (Requires 'repo' scope)</label>
                <input type="password" id="gh-token" class="form-input" placeholder="ghp_xxxxxxxxxxxx">
            </div>
            <div class="form-group">
                <label class="form-label">Setlists Folder (Path in repo)</label>
                <input type="text" id="gh-path" class="form-input" value="content/setlists">
                <p class="text-[10px] text-gray-500 mt-1">Files will be loaded/saved here. E.g. content/setlists</p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeSettings()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveSettings()" class="btn btn-primary">Save Config</button>
            </div>
        </div>
    </div>

    <!-- FILE MANAGER MODAL -->
    <div id="file-modal" class="modal-overlay">
        <div class="modal-content h-[600px]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Open Setlist</h2>
                <button onclick="closeFileManager()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <p class="text-xs text-gray-500 mb-2">Fetching from: <span id="file-path-display" class="font-mono text-gray-300">...</span></p>
            
            <div id="file-list-container" class="file-list custom-scrollbar">
                <!-- File items injected here -->
                <p class="text-center text-gray-500 mt-10">Loading files...</p>
            </div>

            <div class="mt-4 pt-4 border-t border-[#333] flex justify-end">
                <button onclick="closeFileManager()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const MASTER_URL = '../content/Ultraphonics_V3.json';
        
        let state = {
            library: [], 
            setlist: [],
            master: [],
            currentFile: null, // Filename (e.g., 'night1.json')
            config: {
                owner: '',
                repo: '',
                token: '',
                folder: 'content/setlists'
            }
        };

        const els = {
            library: document.getElementById('library-list'),
            setlist: document.getElementById('setlist-area'),
            emptyState: document.getElementById('empty-state'),
            currentFilename: document.getElementById('current-filename'),
            modals: {
                settings: document.getElementById('settings-modal'),
                files: document.getElementById('file-modal')
            },
            loader: {
                el: document.getElementById('main-loader'),
                text: document.getElementById('loader-text')
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadConfig();
            await loadMasterData();
            updateUIState();
            setupDragAndDrop();
        });

        // --- CONFIG ---
        function loadConfig() {
            const saved = localStorage.getItem('up_gh_config');
            if (saved) {
                state.config = JSON.parse(saved);
                updateConnectionStatus(true);
            } else {
                // Default defaults
                state.config.owner = 'tdhckmn';
                state.config.repo = 'ultraphonics-web';
                updateConnectionStatus(false);
            }
        }

        function saveSettings() {
            state.config = {
                owner: document.getElementById('gh-owner').value.trim(),
                repo: document.getElementById('gh-repo').value.trim(),
                token: document.getElementById('gh-token').value.trim(),
                folder: document.getElementById('gh-path').value.trim()
            };
            localStorage.setItem('up_gh_config', JSON.stringify(state.config));
            closeSettings();
            updateConnectionStatus(true);
            updateUIState();
        }

        function openSettings() {
            document.getElementById('gh-owner').value = state.config.owner;
            document.getElementById('gh-repo').value = state.config.repo;
            document.getElementById('gh-token').value = state.config.token;
            document.getElementById('gh-path').value = state.config.folder;
            els.modals.settings.classList.add('active');
        }
        function closeSettings() { els.modals.settings.classList.remove('active'); }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            if (connected && state.config.token) {
                el.innerHTML = `<span class="text-green-500"><i class="fas fa-check-circle"></i> GitHub Connected</span>`;
            } else {
                el.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> Config Required</span>`;
            }
        }

        // --- DATA LOGIC ---
        async function loadMasterData() {
            try {
                const res = await fetch(MASTER_URL);
                if (res.ok) {
                    state.master = await res.json();
                } else {
                    throw new Error("Local file not found");
                }
            } catch (e) {
                console.warn("Using fallback data", e);
                state.master = getFallbackData(); // Fallback defined at bottom
            }
            refreshLibrary();
        }

        function refreshLibrary() {
            // Filter Master against Setlist
            const setlistIds = new Set(state.setlist.map(s => s.id));
            const setlistNames = new Set(state.setlist.map(s => s.lastKnownName));

            state.library = state.master.filter(song => {
                if (song.id && setlistIds.has(song.id)) return false;
                if (setlistNames.has(song.lastKnownName)) return false;
                if (song.lastKnownName === "-hide-") return false;
                return true;
            });
            state.library.sort((a, b) => a.lastKnownName.localeCompare(b.lastKnownName));
            renderLibrary();
        }

        // --- FILE OPERATIONS ---

        function resetToNew() {
            if (state.setlist.length > 0 && !confirm("Discard current setlist?")) return;
            state.setlist = [];
            state.currentFile = null;
            renderSetlist();
            refreshLibrary();
            updateUIState();
        }

        async function openFileManager() {
            els.modals.files.classList.add('active');
            document.getElementById('file-path-display').innerText = state.config.folder;
            const container = document.getElementById('file-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 mt-4"><i class="fas fa-circle-notch fa-spin"></i> Fetching file list...</p>';

            try {
                const url = `https://api.github.com/repos/${state.config.owner}/${state.config.repo}/contents/${state.config.folder}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${state.config.token}` }
                });

                if (res.status === 404) {
                    container.innerHTML = '<p class="text-center text-yellow-500 mt-4">Folder not found. Save a file to create it.</p>';
                    return;
                }
                
                const files = await res.json();
                const jsonFiles = files.filter(f => f.name.endsWith('.json'));

                if (jsonFiles.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 mt-4">No .json files found.</p>';
                    return;
                }

                container.innerHTML = '';
                jsonFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `
                        <span class="font-medium text-gray-200"><i class="fas fa-file-code mr-2 text-gray-500"></i> ${file.name}</span>
                        <button class="text-xs bg-[#333] hover:bg-[#00ddde] hover:text-black px-2 py-1 rounded transition">Load</button>
                    `;
                    div.onclick = () => loadRemoteFile(file);
                    container.appendChild(div);
                });

            } catch (err) {
                container.innerHTML = `<p class="text-center text-red-500 mt-4">Error: ${err.message}</p>`;
            }
        }
        function closeFileManager() { els.modals.files.classList.remove('active'); }

        async function loadRemoteFile(fileObj) {
            showLoader(true, `Loading ${fileObj.name}...`);
            closeFileManager();
            
            try {
                // Fetch content
                const res = await fetch(fileObj.download_url); // Use download_url from API response
                if (!res.ok) throw new Error("Failed to download file");
                
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error("File is not a valid setlist array");

                state.setlist = data;
                state.currentFile = fileObj.name;
                
                renderSetlist();
                refreshLibrary();
                updateUIState();
                
            } catch (err) {
                alert("Error loading file: " + err.message);
            } finally {
                showLoader(false);
            }
        }

        async function saveCurrent() {
            if (!state.currentFile) {
                saveAs();
                return;
            }
            await performSave(state.currentFile);
        }

        async function saveAs() {
            const name = prompt("Enter filename for this setlist (e.g., night1.json):", state.currentFile || "my-setlist.json");
            if (!name) return;
            
            let finalName = name;
            if (!finalName.endsWith('.json')) finalName += '.json';
            
            await performSave(finalName);
        }

        async function performSave(filename) {
            const { owner, repo, token, folder } = state.config;
            if (!token) return alert("Please configure GitHub settings first.");

            showLoader(true, `Saving ${filename}...`);

            try {
                // 1. Get SHA if file exists
                const path = `${folder}/${filename}`;
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                
                let sha = null;
                try {
                    const getRes = await fetch(apiUrl, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    if (getRes.ok) {
                        const meta = await getRes.json();
                        sha = meta.sha;
                    }
                } catch(e) {}

                // 2. Prepare content
                const jsonStr = JSON.stringify(state.setlist, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(jsonStr)));

                // 3. PUT
                const payload = {
                    message: `Update ${filename}: ${new Date().toLocaleString()}`,
                    content: contentBase64,
                    branch: 'main'
                };
                if (sha) payload.sha = sha;

                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(`GitHub Error: ${res.status}`);

                state.currentFile = filename;
                updateUIState();
                alert(`Saved successfully to ${path}`);

            } catch (err) {
                alert(`Save failed: ${err.message}`);
            } finally {
                showLoader(false);
            }
        }

        // --- RENDERING ---

        function renderLibrary() {
            const container = els.library;
            container.innerHTML = '';
            
            const term = document.getElementById('search').value.toLowerCase();
            
            state.library.forEach(song => {
                if (term && !song.lastKnownName.toLowerCase().includes(term)) return;
                container.appendChild(createSongElement(song, false));
            });
            document.getElementById('library-count').textContent = state.library.length;
        }

        function renderSetlist() {
            const container = els.setlist;
            container.innerHTML = ''; // Only clears the song items now, not the empty state div (which is outside)
            
            if (state.setlist.length === 0) {
                els.emptyState.style.display = 'flex'; // Show overlay
            } else {
                els.emptyState.style.display = 'none'; // Hide overlay
                state.setlist.forEach(song => {
                    container.appendChild(createSongElement(song, true));
                });
            }
            updateStatsDisplay();
        }

        function createSongElement(data, isSetlist) {
            const div = document.createElement('div');
            div.className = 'song-item group';
            div.dataset.json = JSON.stringify(data); // Store full data for drags
            div.dataset.id = data.id;

            const isSegue = (data.stop === false);
            const isSetMarker = data.lastKnownName.toLowerCase().startsWith('set');

            div.innerHTML = `
                <div class="flex-1 overflow-hidden flex flex-col">
                    <div class="song-name truncate text-sm font-medium ${isSetMarker ? 'text-lg text-[#fca5a5]' : 'text-gray-200'}">
                        ${data.lastKnownName}
                    </div>
                </div>
                ${isSetlist ? `
                <div class="flex items-center gap-3">
                    ${!isSetMarker ? `
                    <label class="segue-toggle" title="Segue (Don't stop)">
                        <input type="checkbox" onchange="toggleSegue(this)" ${isSegue ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>` : ''}
                    <button onclick="removeItem('${data.id}')" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
                </div>` : ''}
            `;
            return div;
        }

        // --- INTERACTIONS ---
        
        window.toggleSegue = (input) => {
            const el = input.closest('.song-item');
            const data = JSON.parse(el.dataset.json);
            
            // Find in setlist
            const item = state.setlist.find(s => s.id === data.id);
            if (item) {
                item.stop = !input.checked;
                // Update dataset so drag operations carry new state
                el.dataset.json = JSON.stringify(item);
            }
        };

        window.removeItem = (id) => {
            const idx = state.setlist.findIndex(s => s.id === id);
            if (idx > -1) {
                state.setlist.splice(idx, 1);
                renderSetlist();
                refreshLibrary();
            }
        };

        document.getElementById('search').addEventListener('input', () => renderLibrary());
        window.filterLibrary = (type) => {
            document.getElementById('search').value = type === 'sets' ? 'set' : '';
            renderLibrary();
        };

        // --- DRAG & DROP ---
        function setupDragAndDrop() {
            // Library: Pull: clone means we copy the data from source
            new Sortable(els.library, {
                group: { name: 'shared', pull: 'clone', put: false }, 
                sort: false,
                animation: 150,
                draggable: '.song-item',
                forceFallback: true, // IMPORTANT: Forces JS dragging, fixes local preview issues
                fallbackClass: 'sortable-drag', // Class applied to the dragged element
                onEnd: (evt) => {
                    // Item dragged from Library to Setlist
                    // We DO NOT handle state sync here because the target's onAdd will handle it.
                }
            });

            // Setlist: Accepts drop and handles the logic
            new Sortable(els.setlist, {
                group: 'shared',
                animation: 150,
                draggable: '.song-item',
                forceFallback: true, // IMPORTANT: Forces JS dragging here too
                fallbackClass: 'sortable-drag',
                onAdd: (evt) => {
                    // Item dropped here.
                    const data = JSON.parse(evt.item.dataset.json);
                    
                    // 1. Create correct setlist styled element
                    const newEl = createSongElement(data, true);
                    evt.item.replaceWith(newEl);
                    
                    // 2. Sync State (this will update Library to remove the item we just cloned)
                    // We use setTimeout to defer the destruction of the Library DOM
                    // This prevents Sortable from reverting the drag due to source node destruction
                    setTimeout(() => {
                        syncSetlist();
                    }, 10);
                },
                onUpdate: () => {
                     // Defer sync for safety here too
                    setTimeout(() => {
                        syncSetlist();
                    }, 10);
                }
            });
        }

        function syncSetlist() {
            const newArr = [];
            const items = els.setlist.querySelectorAll('.song-item');
            items.forEach(el => {
                newArr.push(JSON.parse(el.dataset.json));
            });
            state.setlist = newArr;
            refreshLibrary(); // Update library to remove moved items
            updateUIState();
        }

        // --- UTILS ---

        function updateUIState() {
            els.currentFilename.textContent = state.currentFile || "(Unsaved)";
            updateStatsDisplay();
            
            const connected = !!(state.config.token && state.config.repo);
            document.getElementById('btn-open').disabled = !connected;
            document.getElementById('btn-save').disabled = !connected;
            document.getElementById('btn-save-as').disabled = !connected;
        }

        function updateStatsDisplay() {
             const statsEl = document.getElementById('setlist-stats');
             if (!statsEl) return;
             
             if (state.setlist.length === 0) {
                 statsEl.textContent = "0 items";
                 return;
             }

             let report = [];
             let bufferCount = 0;
             let bufferName = null;

             state.setlist.forEach(item => {
                 // Check if it's a set marker
                 const name = item.lastKnownName || "";
                 // Using toLowerCase comparison to catch "Set 1", "set 2", "Set3" etc.
                 const isSet = name.toLowerCase().startsWith('set');

                 if (isSet) {
                     // Close previous buffer if it existed
                     if (bufferName !== null) {
                         report.push(`${bufferName} (${bufferCount})`);
                     } else if (bufferCount > 0) {
                         // Songs before the first Set marker
                         report.push(`Intro (${bufferCount})`);
                     }
                     // Start new buffer
                     bufferName = name;
                     bufferCount = 0;
                 } else {
                     bufferCount++;
                 }
             });

             // Close final buffer
             if (bufferName !== null) {
                 report.push(`${bufferName} (${bufferCount})`);
             } else if (bufferCount > 0) {
                 // Only songs, no sets at all
                 report.push(`Total (${bufferCount})`);
             }
             
             statsEl.textContent = report.join(" â€¢ ");
             statsEl.title = report.join("\n"); // Tooltip for full view if truncated
        }

        function showLoader(show, msg) {
            els.loader.el.classList.toggle('active', show);
            if (msg) els.loader.text.innerHTML = `<i class="fas fa-sync fa-spin mr-2"></i> ${msg}`;
        }

        window.downloadLocalJSON = () => {
            const dataStr = JSON.stringify(state.setlist, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = state.currentFile || `setlist-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        };

        function getFallbackData() {
            return [
                { "id": "1", "lastKnownName": "24K Magic", "stop": true },
                { "id": "2", "lastKnownName": "Set 1", "stop": true },
                { "id": "3", "lastKnownName": "Uptown Funk", "stop": true }
            ];
        }

    </script>
</body>
</html>