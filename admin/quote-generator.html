<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quote Generator - Ultraphonics</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/Ultraphonics-Spiral-512.png">

    <!-- Google Fonts - Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Apply Montserrat font globally, but exclude Font Awesome icons */
        body, button, input, select, textarea, h1, h2, h3, h4, h5, h6, p, a, span:not([class*="fa-"]), div:not([class*="fa-"]) {
            font-family: 'Montserrat', sans-serif !important;
        }

        .quote-section {
            border-left: 3px solid #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        /* Auth loading spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .auth-spinner {
            animation: spin 1.5s linear infinite;
        }

        /* Auth loading overlay - matches page background for seamless experience */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: #0c0a09; /* stone-950 */
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-out;
        }
        .auth-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-100 h-full">

    <!-- Top Bar -->
    <div class="bg-stone-900 border-b border-stone-800 px-6 py-4 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <a href="show-manager.html" class="text-stone-400 hover:text-white transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1 class="text-xl font-bold text-white">Quote Generator</h1>
            <span class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs font-bold rounded-full border border-amber-500/30">BETA</span>
            <span class="text-sm text-stone-500" id="show-name"></span>
        </div>
        <div class="flex items-center gap-3">
            <button id="download-pdf-btn" class="px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-500 transition-colors flex items-center gap-2">
                <i class="fa-solid fa-file-pdf"></i>
                Download PDF
            </button>
            <button id="save-quote-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-500 transition-colors flex items-center gap-2">
                <i class="fa-solid fa-save"></i>
                Save Quote
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left: Quote Builder -->
            <div class="space-y-6">
                <div class="bg-stone-900 rounded-xl border border-stone-800 p-6">
                    <h2 class="text-xl font-bold text-white mb-4">Event Details</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">Performance Duration</label>
                            <select id="duration" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                <option value="3">3 hours</option>
                                <option value="4">4 hours</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">Number of Band Members</label>
                            <select id="members" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                <option value="4">4 members</option>
                                <option value="5">5 members</option>
                                <option value="6" selected>6 members</option>
                            </select>
                            <p class="text-xs text-stone-500 mt-2">
                                Premium gigs ($1,000+ base) typically use 6 members
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">Musician Base Rate</label>
                            <div class="flex items-center gap-2">
                                <span class="text-stone-400">$</span>
                                <input type="number" id="musician-base" min="0" step="50" class="flex-1 px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-indigo-500" readonly>
                            </div>
                            <p class="text-xs text-stone-500 mt-2" id="base-recommendation">
                                Auto-calculated based on operational agreement
                            </p>
                            <div class="mt-2">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="custom-rate" class="w-5 h-5 text-indigo-600 bg-stone-800 border-stone-700 rounded focus:ring-indigo-500 focus:ring-2 cursor-pointer">
                                    <span class="text-xs font-semibold text-stone-300">Use custom rate</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="early-arrival" class="w-5 h-5 text-indigo-600 bg-stone-800 border-stone-700 rounded focus:ring-indigo-500 focus:ring-2 cursor-pointer">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-stone-300">Early Arrival Premium (+$300)</span>
                                    <p class="text-stone-500 text-xs mt-1">Arrival before 5:00 PM or early venue setup</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Travel -->
                <div class="bg-stone-900 rounded-xl border border-stone-800 p-6">
                    <h2 class="text-xl font-bold text-white mb-4">Travel & Lodging</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">Travel Distance from Detroit</label>
                            <select id="travel-distance" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                <option value="0">Within 1.5 hours (included)</option>
                                <option value="1">1.5 - 2.5 hours</option>
                                <option value="2">2.5 - 3.5 hours</option>
                                <option value="3">3.5 - 4.5 hours</option>
                                <option value="4">4.5+ hours</option>
                            </select>
                        </div>

                        <div id="lodging-section" class="hidden">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="lodging-required" class="w-5 h-5 text-indigo-600 bg-stone-800 border-stone-700 rounded focus:ring-indigo-500 focus:ring-2 cursor-pointer">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-stone-300">Lodging Required</span>
                                    <p class="text-stone-500 text-xs mt-1">2+ hour one-way travel</p>
                                </div>
                            </label>

                            <div id="lodging-details" class="mt-4 hidden">
                                <label class="block text-sm font-semibold text-stone-300 mb-2">Number of Rooms</label>
                                <input type="number" id="lodging-rooms" min="1" max="6" value="2" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-indigo-500">

                                <label class="block text-sm font-semibold text-stone-300 mb-2 mt-4">Estimated Room Rate</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-stone-400">$</span>
                                    <input type="number" id="room-rate" min="0" value="175" class="flex-1 px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                                    <span class="text-stone-400">per room</span>
                                </div>
                                <p class="text-xs text-stone-500 mt-2">Target: $150-$200/room, mid-tier hotel</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add-ons -->
                <div class="bg-stone-900 rounded-xl border border-stone-800 p-6">
                    <h2 class="text-xl font-bold text-white mb-4">Add-On Services</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="cocktail-hour" class="w-5 h-5 text-indigo-600 bg-stone-800 border-stone-700 rounded focus:ring-indigo-500 focus:ring-2 cursor-pointer">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-stone-300">Cocktail Hour Live Trio</span>
                                </div>
                            </label>
                            <div id="cocktail-details" class="ml-8 mt-2 hidden">
                                <label class="block text-xs text-stone-500 mb-1">Duration (hours)</label>
                                <input type="number" id="cocktail-hours" min="1" max="3" value="1" step="0.5" class="w-32 px-3 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500">
                                <p class="text-xs text-stone-500 mt-1">$300/hr base + $100 per additional musician</p>
                            </div>
                        </div>

                        <div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="additional-audio" class="w-5 h-5 text-indigo-600 bg-stone-800 border-stone-700 rounded focus:ring-indigo-500 focus:ring-2 cursor-pointer">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-stone-300">Additional Audio Locations</span>
                                </div>
                            </label>
                            <div id="audio-details" class="ml-8 mt-2 hidden space-y-2">
                                <div>
                                    <label class="block text-xs text-stone-500 mb-1">Basic Packages ($200 each)</label>
                                    <input type="number" id="audio-basic" min="0" max="5" value="0" class="w-32 px-3 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500">
                                    <p class="text-xs text-stone-500 mt-1">Small PA + wireless mic</p>
                                </div>
                                <div>
                                    <label class="block text-xs text-stone-500 mb-1">Premium Packages ($500 each)</label>
                                    <input type="number" id="audio-premium" min="0" max="5" value="0" class="w-32 px-3 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500">
                                    <p class="text-xs text-stone-500 mt-1">Full system with subs</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="additional-musicians" class="w-5 h-5 text-indigo-600 bg-stone-800 border-stone-700 rounded focus:ring-indigo-500 focus:ring-2 cursor-pointer">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-stone-300">Additional Musicians</span>
                                </div>
                            </label>
                            <div id="musicians-details" class="ml-8 mt-2 hidden space-y-3">
                                <div>
                                    <label class="block text-xs text-stone-500 mb-1">Number of Musicians</label>
                                    <input type="number" id="musicians-count" min="1" max="10" value="1" class="w-32 px-3 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500">
                                    <p class="text-xs text-stone-500 mt-1">e.g., horn section, pianist, etc.</p>
                                </div>
                                <div>
                                    <label class="block text-xs text-stone-500 mb-1">Rate per Musician</label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-stone-400 text-sm">$</span>
                                        <input type="number" id="musician-rate" min="0" step="50" value="150" class="w-32 px-3 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs text-stone-500 mb-1">Notes (instruments, names, etc.)</label>
                                    <textarea id="musicians-notes" rows="2" class="w-full px-3 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500 resize-y" placeholder="e.g., Saxophone and trumpet for cocktail hour and first set"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Quote Summary -->
            <div class="lg:sticky lg:top-24 h-fit">
                <div class="bg-stone-900 rounded-xl border border-stone-800 p-6">
                    <h2 class="text-xl font-bold text-white mb-6">Quote Summary</h2>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-stone-300">
                            <span>Musician Base</span>
                            <span id="summary-base">$0</span>
                        </div>
                        <div class="flex justify-between text-stone-300" id="summary-early-row" style="display: none;">
                            <span>Early Arrival Premium</span>
                            <span>$300</span>
                        </div>
                        <div class="flex justify-between text-stone-300" id="summary-travel-row" style="display: none;">
                            <span>Travel Compensation</span>
                            <span id="summary-travel">$0</span>
                        </div>
                        <div class="flex justify-between text-stone-300" id="summary-lodging-row" style="display: none;">
                            <span>Lodging</span>
                            <span id="summary-lodging">$0</span>
                        </div>
                        <div class="flex justify-between text-stone-300" id="summary-cocktail-row" style="display: none;">
                            <span>Cocktail Hour</span>
                            <span id="summary-cocktail">$0</span>
                        </div>
                        <div class="flex justify-between text-stone-300" id="summary-audio-row" style="display: none;">
                            <span>Additional Audio</span>
                            <span id="summary-audio">$0</span>
                        </div>
                        <div class="flex justify-between text-stone-300" id="summary-musicians-row" style="display: none;">
                            <span>Additional Musicians</span>
                            <span id="summary-musicians">$0</span>
                        </div>
                    </div>

                    <div class="border-t border-stone-700 pt-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-white">Total Quote</span>
                            <span class="text-3xl font-bold text-indigo-400" id="total-quote">$0</span>
                        </div>
                    </div>

                    <div class="quote-section p-4 rounded-lg mb-6">
                        <h3 class="text-sm font-bold text-indigo-400 mb-2">Per Member Breakdown</h3>
                        <div class="text-stone-300 text-sm space-y-1">
                            <div class="flex justify-between">
                                <span>Each member receives:</span>
                                <span class="font-semibold" id="per-member">$0</span>
                            </div>
                            <p class="text-xs text-stone-500 mt-2">
                                All performance and add-on revenue distributed evenly among <span id="member-count">5</span> performing members
                            </p>
                        </div>
                    </div>

                    <div class="bg-stone-800 rounded-lg p-4">
                        <h3 class="text-sm font-bold text-stone-300 mb-3">Notes</h3>
                        <textarea id="quote-notes" rows="4" class="w-full px-3 py-2 bg-stone-900 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500 resize-y" placeholder="Add any special notes or conditions for this quote..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Bundle -->
    <script src="/dist/firebase-bundle.js"></script>

    <!-- Auth Loading Overlay - shows spinning logo while checking auth -->
    <div id="auth-loading" class="auth-overlay">
        <div class="text-center">
            <img src="/assets/images/Ultraphonics-Spiral-192.png" alt="Loading" class="h-16 w-auto mx-auto auth-spinner">
        </div>
    </div>

    <!-- Login Modal - only shown if not authenticated -->
    <div id="login-modal" class="fixed inset-0 bg-stone-950 flex items-center justify-center z-[200] hidden">
        <div id="login-form" class="bg-stone-900 w-full max-w-md mx-auto rounded-xl shadow-2xl border border-stone-700 overflow-hidden m-4">
            <div class="p-6">
                <div class="text-center mb-6">
                    <img src="/assets/images/Ultraphonics-Spiral-192.png" alt="Ultraphonics" class="h-16 w-auto mx-auto mb-4">
                    <h2 class="text-xl font-bold text-white">Admin Login</h2>
                    <p class="text-stone-400 text-sm mt-1">Sign in to create and manage quotes</p>
                </div>

                <div id="login-error" class="text-red-400 text-sm hidden mb-4 text-center"></div>
                <button id="google-sign-in-btn"
                    class="w-full px-4 py-3 bg-white rounded-lg text-gray-800 hover:bg-gray-100 font-semibold transition-colors flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <script>
        let show = null;
        let showId = null;
        let shows = []; // Store all shows for reference

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        showId = urlParams.get('show');
        const quoteId = urlParams.get('quote');
        const isNew = urlParams.get('new') === 'true';

        // UUID generator function
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Load show data from Firestore
        async function loadShowData() {
            try {
                if (!window.FirestoreService) {
                    throw new Error("Firebase not loaded");
                }

                shows = await window.FirestoreService.getShows();

                // Find show by UUID
                if (showId !== null) {
                    show = shows.find(s => s.id === showId);
                    if (show) {
                        document.getElementById('show-name').textContent = `${show.venue} - ${show.date}`;

                        // If editing existing quote, load it
                        if (quoteId && !isNew) {
                            await loadExistingQuote(quoteId);
                        }
                    } else {
                        throw new Error(`Show with ID ${showId} not found`);
                    }
                }
            } catch (error) {
                console.error('Error loading show:', error);
                alert(`Failed to load show data: ${error.message}`);
            }
        }

        // Load existing quote from Firestore
        async function loadExistingQuote(quoteId) {
            try {
                if (!window.FirestoreService) {
                    throw new Error("Firebase not loaded");
                }

                const quote = await window.FirestoreService.getQuote(quoteId);

                if (!quote) {
                    throw new Error(`Quote not found: ${quoteId}`);
                }

                // Populate form with quote data
                document.getElementById('duration').value = quote.duration;
                document.getElementById('members').value = quote.members;
                document.getElementById('musician-base').value = quote.musicianBase;
                document.getElementById('early-arrival').checked = quote.earlyArrival || false;
                document.getElementById('travel-distance').value = quote.travelDistance || 0;

                if (quote.lodging) {
                    document.getElementById('lodging-required').checked = true;
                    document.getElementById('lodging-rooms').value = quote.lodging.rooms;
                    document.getElementById('room-rate').value = quote.lodging.roomRate;
                    document.getElementById('lodging-section').classList.remove('hidden');
                    document.getElementById('lodging-details').classList.remove('hidden');
                }

                if (quote.cocktailHour) {
                    document.getElementById('cocktail-hour').checked = true;
                    document.getElementById('cocktail-hours').value = quote.cocktailHour.hours;
                    document.getElementById('cocktail-details').classList.remove('hidden');
                }

                if (quote.additionalAudio) {
                    document.getElementById('additional-audio').checked = true;
                    document.getElementById('audio-basic').value = quote.additionalAudio.basic || 0;
                    document.getElementById('audio-premium').value = quote.additionalAudio.premium || 0;
                    document.getElementById('audio-details').classList.remove('hidden');
                }

                if (quote.additionalMusicians) {
                    document.getElementById('additional-musicians').checked = true;
                    document.getElementById('musicians-count').value = quote.additionalMusicians.count || 0;
                    document.getElementById('musician-rate').value = quote.additionalMusicians.rate || 0;
                    document.getElementById('musicians-notes').value = quote.additionalMusicians.notes || '';
                    document.getElementById('musicians-details').classList.remove('hidden');
                }

                if (quote.notes) {
                    document.getElementById('quote-notes').value = quote.notes;
                }

                updateCalculations();
            } catch (error) {
                console.error('Error loading quote:', error);
                alert(`Failed to load quote: ${error.message}`);
            }
        }

        // Calculate musician base from operational agreement
        function calculateMusicianBase(duration, members) {
            // Based on operational agreement section 3.3
            if (duration === 3) {
                if (members === 4) {
                    // 4-piece, 3-hour: $150 minimum per person
                    return 600;
                } else if (members === 5) {
                    // 5-piece, 3-hour: $750 base
                    return 750;
                } else if (members === 6) {
                    // 6-piece, 3-hour: $1,000 base
                    return 1000;
                }
            } else if (duration === 4) {
                if (members === 4) {
                    // 4-piece, 4-hour: $160 minimum per person
                    return 640;
                } else if (members === 5) {
                    // 5-piece, 4-hour: $800 base
                    return 800;
                } else if (members === 6) {
                    // 6-piece, 4-hour: $1,000 base
                    return 1000;
                }
            }
            // Default fallback
            return members * 150;
        }

        // Update all calculations
        function updateCalculations() {
            const duration = parseInt(document.getElementById('duration').value);
            const members = parseInt(document.getElementById('members').value);
            const customRate = document.getElementById('custom-rate').checked;

            let musicianBase;
            if (customRate) {
                musicianBase = parseInt(document.getElementById('musician-base').value) || 0;
            } else {
                musicianBase = calculateMusicianBase(duration, members);
                document.getElementById('musician-base').value = musicianBase;
            }

            const earlyArrival = document.getElementById('early-arrival').checked;
            const travelDistance = parseInt(document.getElementById('travel-distance').value);

            // Update recommendation
            updateRecommendation(duration, members, musicianBase);

            // Calculate travel
            const travelCost = travelDistance > 0 ? (travelDistance * 60 * members) : 0;

            // Calculate lodging
            let lodgingCost = 0;
            if (document.getElementById('lodging-required').checked) {
                const rooms = parseInt(document.getElementById('lodging-rooms').value) || 0;
                const roomRate = parseInt(document.getElementById('room-rate').value) || 0;
                lodgingCost = rooms * roomRate;
            }

            // Calculate cocktail hour
            let cocktailCost = 0;
            if (document.getElementById('cocktail-hour').checked) {
                const hours = parseFloat(document.getElementById('cocktail-hours').value) || 0;
                cocktailCost = hours * 300; // Base $300/hr
            }

            // Calculate additional audio
            let audioCost = 0;
            if (document.getElementById('additional-audio').checked) {
                const basic = parseInt(document.getElementById('audio-basic').value) || 0;
                const premium = parseInt(document.getElementById('audio-premium').value) || 0;
                audioCost = (basic * 200) + (premium * 500);
            }

            // Calculate additional musicians
            let musiciansCost = 0;
            if (document.getElementById('additional-musicians').checked) {
                const count = parseInt(document.getElementById('musicians-count').value) || 0;
                const rate = parseInt(document.getElementById('musician-rate').value) || 0;
                musiciansCost = count * rate;
            }

            // Calculate total
            let total = musicianBase;
            if (earlyArrival) total += 300;
            total += travelCost;
            total += lodgingCost;
            total += cocktailCost;
            total += audioCost;
            total += musiciansCost;

            // Update summary
            document.getElementById('summary-base').textContent = `$${musicianBase.toLocaleString()}`;

            document.getElementById('summary-early-row').style.display = earlyArrival ? 'flex' : 'none';

            if (travelCost > 0) {
                document.getElementById('summary-travel-row').style.display = 'flex';
                document.getElementById('summary-travel').textContent = `$${travelCost.toLocaleString()}`;
            } else {
                document.getElementById('summary-travel-row').style.display = 'none';
            }

            if (lodgingCost > 0) {
                document.getElementById('summary-lodging-row').style.display = 'flex';
                document.getElementById('summary-lodging').textContent = `$${lodgingCost.toLocaleString()}`;
            } else {
                document.getElementById('summary-lodging-row').style.display = 'none';
            }

            if (cocktailCost > 0) {
                document.getElementById('summary-cocktail-row').style.display = 'flex';
                document.getElementById('summary-cocktail').textContent = `$${cocktailCost.toLocaleString()}`;
            } else {
                document.getElementById('summary-cocktail-row').style.display = 'none';
            }

            if (audioCost > 0) {
                document.getElementById('summary-audio-row').style.display = 'flex';
                document.getElementById('summary-audio').textContent = `$${audioCost.toLocaleString()}`;
            } else {
                document.getElementById('summary-audio-row').style.display = 'none';
            }

            if (musiciansCost > 0) {
                document.getElementById('summary-musicians-row').style.display = 'flex';
                document.getElementById('summary-musicians').textContent = `$${musiciansCost.toLocaleString()}`;
            } else {
                document.getElementById('summary-musicians-row').style.display = 'none';
            }

            document.getElementById('total-quote').textContent = `$${total.toLocaleString()}`;

            // Calculate per member (excluding lodging, that's separate)
            const performanceRevenue = total - lodgingCost;
            const perMember = Math.round(performanceRevenue / members);
            document.getElementById('per-member').textContent = `$${perMember.toLocaleString()}`;
            document.getElementById('member-count').textContent = members;
        }

        // Update recommendation text
        function updateRecommendation(duration, members, musicianBase) {
            const rec = document.getElementById('base-recommendation');
            const perMember = Math.round(musicianBase / members);
            const minimum = duration === 3 ? 150 : 160;

            if (document.getElementById('custom-rate').checked) {
                if (perMember < minimum) {
                    rec.textContent = `⚠️ Below minimum: $${minimum}/member for ${duration}hr`;
                    rec.classList.add('text-red-400');
                } else {
                    rec.textContent = `Custom rate: $${perMember}/member`;
                    rec.classList.remove('text-red-400');
                }
            } else {
                rec.textContent = `Auto-calculated: $${perMember}/member (${duration}hr, ${members}-piece)`;
                rec.classList.remove('text-red-400');
            }
        }

        // Save quote to Firestore
        async function saveQuote() {
            if (!show) {
                alert('No show data available');
                return;
            }

            if (!window.FirestoreService) {
                alert('Firebase not loaded');
                return;
            }

            if (!window.FirebaseAuth?.isAuthenticated()) {
                alert('Please sign in to save quotes');
                return;
            }

            const saveBtn = document.getElementById('save-quote-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            try {
                // Generate or retrieve quote UUID
                let quoteUuid;
                if (quoteId && !isNew) {
                    // Editing existing quote, use existing UUID
                    quoteUuid = quoteId;
                } else {
                    // Creating new quote, generate new UUID
                    quoteUuid = generateUUID();
                }

                const quote = {
                    id: quoteUuid,
                    showId: showId,
                    showVenue: show.venue,
                    showDate: show.date,
                    duration: parseInt(document.getElementById('duration').value),
                    members: parseInt(document.getElementById('members').value),
                    musicianBase: parseInt(document.getElementById('musician-base').value),
                    earlyArrival: document.getElementById('early-arrival').checked,
                    travelDistance: parseInt(document.getElementById('travel-distance').value),
                    notes: document.getElementById('quote-notes').value,
                    createdAt: new Date().toISOString(),
                    total: parseInt(document.getElementById('total-quote').textContent.replace(/[$,]/g, ''))
                };

                if (document.getElementById('lodging-required').checked) {
                    quote.lodging = {
                        rooms: parseInt(document.getElementById('lodging-rooms').value),
                        roomRate: parseInt(document.getElementById('room-rate').value)
                    };
                }

                if (document.getElementById('cocktail-hour').checked) {
                    quote.cocktailHour = {
                        hours: parseFloat(document.getElementById('cocktail-hours').value)
                    };
                }

                if (document.getElementById('additional-audio').checked) {
                    quote.additionalAudio = {
                        basic: parseInt(document.getElementById('audio-basic').value) || 0,
                        premium: parseInt(document.getElementById('audio-premium').value) || 0
                    };
                }

                if (document.getElementById('additional-musicians').checked) {
                    quote.additionalMusicians = {
                        count: parseInt(document.getElementById('musicians-count').value) || 0,
                        rate: parseInt(document.getElementById('musician-rate').value) || 0,
                        notes: document.getElementById('musicians-notes').value.trim()
                    };
                }

                // Save quote to Firestore
                await window.FirestoreService.saveQuote(quote);

                // Update show with quote reference
                show.quoteId = quoteUuid;
                await window.FirestoreService.saveShow(show);

                saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
                setTimeout(() => {
                    window.close();
                }, 1500);

            } catch (error) {
                console.error('Error saving quote:', error);
                alert(`Failed to save quote: ${error.message}`);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Quote';
            }
        }

        // Event listeners
        document.getElementById('duration').addEventListener('change', updateCalculations);
        document.getElementById('members').addEventListener('change', updateCalculations);
        document.getElementById('custom-rate').addEventListener('change', function() {
            const musicianBaseInput = document.getElementById('musician-base');
            if (this.checked) {
                musicianBaseInput.removeAttribute('readonly');
                musicianBaseInput.classList.add('bg-stone-800');
                musicianBaseInput.classList.remove('bg-stone-900');
            } else {
                musicianBaseInput.setAttribute('readonly', 'readonly');
                musicianBaseInput.classList.remove('bg-stone-800');
                musicianBaseInput.classList.add('bg-stone-900');
            }
            updateCalculations();
        });
        document.getElementById('musician-base').addEventListener('input', updateCalculations);
        document.getElementById('early-arrival').addEventListener('change', updateCalculations);
        document.getElementById('travel-distance').addEventListener('change', function() {
            const distance = parseInt(this.value);
            const lodgingSection = document.getElementById('lodging-section');
            if (distance >= 2) {
                lodgingSection.classList.remove('hidden');
            } else {
                lodgingSection.classList.add('hidden');
                document.getElementById('lodging-required').checked = false;
            }
            updateCalculations();
        });

        document.getElementById('lodging-required').addEventListener('change', function() {
            const details = document.getElementById('lodging-details');
            if (this.checked) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
            updateCalculations();
        });
        document.getElementById('lodging-rooms').addEventListener('input', updateCalculations);
        document.getElementById('room-rate').addEventListener('input', updateCalculations);

        document.getElementById('cocktail-hour').addEventListener('change', function() {
            const details = document.getElementById('cocktail-details');
            if (this.checked) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
            updateCalculations();
        });
        document.getElementById('cocktail-hours').addEventListener('input', updateCalculations);

        document.getElementById('additional-audio').addEventListener('change', function() {
            const details = document.getElementById('audio-details');
            if (this.checked) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
            updateCalculations();
        });
        document.getElementById('audio-basic').addEventListener('input', updateCalculations);
        document.getElementById('audio-premium').addEventListener('input', updateCalculations);

        document.getElementById('additional-musicians').addEventListener('change', function() {
            const details = document.getElementById('musicians-details');
            if (this.checked) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
            updateCalculations();
        });
        document.getElementById('musicians-count').addEventListener('input', updateCalculations);
        document.getElementById('musician-rate').addEventListener('input', updateCalculations);

        document.getElementById('save-quote-btn').addEventListener('click', saveQuote);

        // PDF Download
        document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get current values
            const duration = parseInt(document.getElementById('duration').value);
            const members = parseInt(document.getElementById('members').value);
            const musicianBase = parseInt(document.getElementById('musician-base').value) || 0;
            const earlyArrival = document.getElementById('early-arrival').checked;
            const travelDistance = parseInt(document.getElementById('travel-distance').value);
            const totalQuote = document.getElementById('total-quote').textContent;
            const perMember = document.getElementById('per-member').textContent;
            const notes = document.getElementById('quote-notes').value;

            // Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('ULTRAPHONICS', 105, 20, { align: 'center' });

            doc.setFontSize(16);
            doc.text('Performance Quote', 105, 28, { align: 'center' });
            doc.text('(THIS FEATURE IS A WORK IN PROGRESS)', 105, 28, { align: 'center' });

            // Show info
            if (show) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`${show.venue}`, 105, 38, { align: 'center' });
                doc.text(`${show.date}`, 105, 44, { align: 'center' });
            }

            // Line separator
            doc.setDrawColor(100, 100, 100);
            doc.line(20, 50, 190, 50);

            let yPos = 60;

            // Event Details
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Event Details', 20, yPos);
            yPos += 8;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Performance Duration: ${duration} hours`, 25, yPos);
            yPos += 6;
            doc.text(`Number of Band Members: ${members}`, 25, yPos);
            yPos += 6;
            if (earlyArrival) {
                doc.text(`Early Arrival Premium: Included`, 25, yPos);
                yPos += 6;
            }
            if (travelDistance > 0) {
                const travelLabels = ['Within 1.5 hours', '1.5 - 2.5 hours', '2.5 - 3.5 hours', '3.5 - 4.5 hours', '4.5+ hours'];
                doc.text(`Travel Distance: ${travelLabels[travelDistance]}`, 25, yPos);
                yPos += 6;
            }

            yPos += 4;

            // Add-ons
            let hasAddons = false;
            if (document.getElementById('cocktail-hour').checked) {
                if (!hasAddons) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Add-On Services', 20, yPos);
                    yPos += 8;
                    hasAddons = true;
                }
                const hours = parseFloat(document.getElementById('cocktail-hours').value);
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Cocktail Hour Live Trio: ${hours} hour${hours !== 1 ? 's' : ''}`, 25, yPos);
                yPos += 6;
            }

            if (document.getElementById('additional-audio').checked) {
                if (!hasAddons) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Add-On Services', 20, yPos);
                    yPos += 8;
                    hasAddons = true;
                }
                const basic = parseInt(document.getElementById('audio-basic').value) || 0;
                const premium = parseInt(document.getElementById('audio-premium').value) || 0;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                if (basic > 0) {
                    doc.text(`Additional Audio (Basic): ${basic} location${basic !== 1 ? 's' : ''}`, 25, yPos);
                    yPos += 6;
                }
                if (premium > 0) {
                    doc.text(`Additional Audio (Premium): ${premium} location${premium !== 1 ? 's' : ''}`, 25, yPos);
                    yPos += 6;
                }
            }

            if (document.getElementById('additional-musicians').checked) {
                if (!hasAddons) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Add-On Services', 20, yPos);
                    yPos += 8;
                    hasAddons = true;
                }
                const count = parseInt(document.getElementById('musicians-count').value) || 0;
                const musicianNotes = document.getElementById('musicians-notes').value.trim();
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Additional Musicians: ${count} musician${count !== 1 ? 's' : ''}`, 25, yPos);
                yPos += 6;
                if (musicianNotes) {
                    const splitNotes = doc.splitTextToSize(musicianNotes, 160);
                    doc.text(splitNotes, 25, yPos);
                    yPos += (splitNotes.length * 6);
                }
            }

            if (hasAddons) yPos += 4;

            // Line separator
            doc.setDrawColor(100, 100, 100);
            doc.line(20, yPos, 190, yPos);
            yPos += 10;

            // Quote Summary
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Total Quote:', 20, yPos);
            doc.text(totalQuote, 190, yPos, { align: 'right' });
            yPos += 10;

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Per Member: ${perMember}`, 20, yPos);
            yPos += 10;

            // Notes
            if (notes) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Notes:', 20, yPos);
                yPos += 6;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const splitNotes = doc.splitTextToSize(notes, 170);
                doc.text(splitNotes, 20, yPos);
            }

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Generated by Ultraphonics Quote Generator', 105, 285, { align: 'center' });

            // Save the PDF
            const filename = show ? `Ultraphonics_Quote_${show.venue.replace(/\s+/g, '_')}_${show.date.replace(/\//g, '-')}.pdf` : 'Ultraphonics_Quote.pdf';
            doc.save(filename);
        }

        // --- Firebase Auth Setup ---
        function setupAuth() {
            const loginModal = document.getElementById('login-modal');
            const authLoading = document.getElementById('auth-loading');
            const loginForm = document.getElementById('login-form');
            const googleSignInBtn = document.getElementById('google-sign-in-btn');
            const loginError = document.getElementById('login-error');

            function showLoginForm() {
                // Fade out loading overlay, then show login modal
                authLoading.classList.add('fade-out');
                setTimeout(() => {
                    authLoading.style.display = 'none';
                    loginModal.classList.remove('hidden');
                }, 300);
                loginError.classList.add('hidden');
            }

            function hideLoginModal() {
                // Fade out the loading overlay smoothly
                authLoading.classList.add('fade-out');
                setTimeout(() => {
                    authLoading.style.display = 'none';
                }, 300);
                loginModal.classList.add('hidden');
            }

            googleSignInBtn.addEventListener('click', async () => {
                googleSignInBtn.disabled = true;
                googleSignInBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Signing in...';
                loginError.classList.add('hidden');

                try {
                    await window.FirebaseAuth.loginWithGoogle();
                    hideLoginModal();
                } catch (error) {
                    console.error('Login error:', error);
                    loginError.textContent = error.message || 'Sign in failed';
                    loginError.classList.remove('hidden');
                } finally {
                    googleSignInBtn.disabled = false;
                    googleSignInBtn.innerHTML = `
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    `;
                }
            });

            // Auth state listener - show login form only if confirmed not authenticated
            window.FirebaseAuth.onAuthChange((user) => {
                if (!user) {
                    // Not authenticated - show login form
                    showLoginForm();
                } else {
                    // Authenticated - hide the entire modal
                    hideLoginModal();
                }
            });
        }

        // Initialize
        setupAuth();
        loadShowData();
        updateCalculations();
    </script>

</body>
</html>
