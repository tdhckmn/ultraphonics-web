<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Show Manager - Ultraphonics</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/Ultraphonics-Spiral-512.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- Google Fonts - Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Apply Montserrat font globally, but exclude Font Awesome icons */
        body, button, input, select, textarea, h1, h2, h3, h4, h5, h6, p, a, span:not([class*="fa-"]), div:not([class*="fa-"]) {
            font-family: 'Montserrat', sans-serif !important;
        }

        /* Manager Layout */
        .manager-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 1fr;
            gap: 1.5rem;
            height: calc(100vh - 70px);
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1023px) {
            .manager-container {
                display: flex;
                flex-direction: column;
                padding: 0.5rem;
                height: calc(100vh - 70px);
                overflow: hidden;
            }
            #shows-list {
                flex: 1;
                display: flex;
            }
            #shows-list.hidden-mobile {
                display: none !important;
            }
            #show-editor {
                flex: 1;
                position: absolute;
                top: 70px;
                left: 0;
                right: 0;
                bottom: 0;
                display: none;
                background: #1c1917;
                z-index: 40;
            }
            #show-editor.active-mobile {
                display: flex !important;
            }
        }

        /* Show List Styles */
        .show-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .show-item:hover {
            background: rgba(20, 184, 166, 0.1);
        }

        .show-item.selected {
            background: rgba(20, 184, 166, 0.2);
            border-left: 3px solid #14b8a6;
        }

        /* Teal theme colors */
        .bg-accent-teal {
            background-color: #14b8a6;
        }

        .text-accent-teal {
            color: #14b8a6;
        }

        .border-accent-teal {
            border-color: #14b8a6;
        }

        .hover\:bg-accent-teal:hover {
            background-color: #14b8a6;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-100 h-full overflow-hidden">

    <!-- Top Bar -->
    <div class="bg-stone-900 border-b border-stone-800 px-4 md:px-6 py-3 md:py-4 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-2 md:gap-3">
            <a href="index.html" class="text-stone-400 hover:text-white transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1 class="text-lg md:text-xl font-bold text-white"><span class="hidden md:inline">Show Manager</span><span class="md:hidden">Shows</span></h1>
            <span class="text-sm text-stone-500 hidden md:inline" id="show-count">0 shows</span>
            <select id="year-filter" class="px-2 md:px-3 py-1 md:py-1.5 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-accent-teal">
                <option value="">All Years</option>
            </select>
        </div>
        <div class="flex items-center gap-1 md:gap-2">
            <span id="connection-status" class="hidden md:inline text-xs px-2 py-1 rounded bg-stone-800 text-stone-400">
                <i class="fa-solid fa-circle text-[8px] mr-1"></i> <span id="connection-label">Read Only</span>
            </span>
            <button id="settings-btn" class="text-stone-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-stone-800" title="Admin Settings">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button id="add-show-btn" class="p-2 md:px-3 md:py-2 bg-accent-teal text-white rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2" title="Add Show">
                <i class="fa-solid fa-plus text-sm"></i>
                <span class="hidden md:inline text-sm font-semibold">Add Show</span>
            </button>
            <button id="save-btn" class="p-2 md:px-3 md:py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 transition-colors hidden flex items-center gap-2" title="Save Changes">
                <i class="fa-solid fa-save text-sm"></i>
                <span class="hidden md:inline text-sm font-semibold">Save</span>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
        <div class="bg-stone-900 w-full max-w-md mx-auto rounded-xl shadow-2xl border border-stone-700 overflow-hidden m-4">
            <div class="p-6">
                <div class="flex justify-between items-center pb-3 border-b border-stone-800">
                    <p class="text-lg font-bold text-white">Admin Settings</p>
                    <button id="close-settings" class="text-stone-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>

                <div class="my-5">
                    <!-- GitHub Authentication -->
                    <label class="block text-stone-400 text-xs font-bold mb-2">
                        GitHub Authentication
                    </label>

                    <a href="https://github.com/settings/tokens/new?description=Ultraphonics%20Admin&scopes=repo"
                       target="_blank"
                       class="block w-full px-4 py-3 bg-indigo-600 rounded-lg text-white hover:bg-indigo-500 font-bold transition-colors mb-2 text-center">
                        <i class="fab fa-github mr-2"></i> Create GitHub Token
                    </a>
                    <p class="text-stone-500 text-xs mb-3 italic">
                        Opens GitHub with the token form pre-filled. Copy the token and paste below.
                    </p>

                    <label class="block text-stone-400 text-xs font-bold mb-2">
                        Personal Access Token
                    </label>
                    <input class="appearance-none border border-stone-700 rounded w-full py-3 px-3 text-stone-200 bg-stone-800 leading-tight focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 mb-1"
                        id="settings-gh-token" type="password" placeholder="ghp_...">
                    <p class="text-stone-500 text-xs mt-1 italic mb-4">
                        Required for saving shows to GitHub
                    </p>

                    <!-- Cache Buster -->
                    <div class="border-t border-stone-800 mt-5 pt-5">
                        <label class="block text-stone-400 text-xs font-bold mb-2">
                            Refresh Page
                        </label>
                        <button id="clear-cache-btn" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white hover:bg-stone-700 font-semibold transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            <span>Clear Cache & Reload</span>
                        </button>
                        <p class="text-stone-500 text-xs mt-2 italic">
                            Use this if you don't see recent updates or changes
                        </p>
                    </div>
                </div>
            </div>

            <div class="border-t border-stone-800 bg-stone-900 px-6 py-4 flex justify-end">
                <button id="save-settings-btn" class="px-6 py-3 bg-indigo-600 rounded-lg text-white hover:bg-indigo-500 font-bold transition-colors">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="manager-container">
        <!-- Left Sidebar: Shows List -->
        <div id="shows-list" class="bg-stone-900 rounded-xl border border-stone-800 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-stone-800">
                <input type="text" id="search-shows" placeholder="Search shows..." class="w-full px-4 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white placeholder-stone-500 focus:outline-none focus:border-accent-teal">
            </div>
            <div id="shows-list-container" class="flex-1 overflow-y-auto">
                <!-- Shows will be populated here -->
            </div>
            <div class="p-3 border-t border-stone-800 bg-stone-800 flex justify-center">
                <span id="events-counter" class="text-accent-teal font-mono text-sm">0 events</span>
            </div>
        </div>

        <!-- Right: Show Editor -->
        <div id="show-editor" class="bg-stone-900 rounded-xl border border-stone-800 overflow-hidden flex flex-col">
            <div id="empty-state" class="flex-1 flex items-center justify-center text-stone-500">
                <div class="text-center">
                    <i class="fa-solid fa-calendar-days text-6xl mb-4 opacity-20"></i>
                    <p class="text-lg">Select a show to view or edit</p>
                </div>
            </div>

            <div id="show-view" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="p-4 md:p-6 border-b border-stone-800 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <h2 class="text-xl md:text-2xl font-bold text-white truncate" id="show-title">Show Details</h2>
                    </div>
                    <div class="flex items-center gap-1 md:gap-2 flex-shrink-0">
                        <button id="download-cal-btn" class="p-2 md:px-3 md:py-2 bg-stone-700 text-white rounded-lg hover:bg-stone-600 transition-colors flex items-center gap-2" title="Download Calendar Event">
                            <i class="fa-solid fa-calendar-plus text-sm"></i>
                            <span class="hidden md:inline text-sm font-semibold">Calendar</span>
                        </button>
                        <button id="edit-btn" class="p-2 md:px-3 md:py-2 bg-accent-teal text-white rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2" title="Edit">
                            <i class="fa-solid fa-pen text-sm"></i>
                            <span class="hidden md:inline text-sm font-semibold">Edit</span>
                        </button>
                        <button id="delete-btn" class="p-2 md:px-3 md:py-2 bg-red-600 text-white rounded-lg hover:bg-red-500 transition-colors flex items-center gap-2" title="Delete">
                            <i class="fa-solid fa-trash text-sm"></i>
                            <span class="hidden md:inline text-sm font-semibold">Delete</span>
                        </button>
                        <button id="back-to-list-btn" class="lg:hidden p-2 text-stone-400 hover:text-white transition-colors ml-2" title="Close">
                            <i class="fa-solid fa-xmark text-lg"></i>
                        </button>
                    </div>
                </div>
                <div id="show-details" class="flex-1 overflow-y-auto p-6">
                    <!-- View mode content -->
                </div>
            </div>

            <div id="show-edit" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="p-4 md:p-6 border-b border-stone-800 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <h2 class="text-xl md:text-2xl font-bold text-white">Edit Show</h2>
                    </div>
                    <div class="flex items-center gap-1 md:gap-2 flex-shrink-0">
                        <button id="save-edit-btn" class="p-2 md:px-3 md:py-2 bg-accent-teal text-white rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2" title="Save">
                            <i class="fa-solid fa-check text-sm"></i>
                            <span class="hidden md:inline text-sm font-semibold">Save</span>
                        </button>
                        <button id="cancel-edit-btn" class="p-2 md:px-3 md:py-2 bg-stone-700 text-white rounded-lg hover:bg-stone-600 transition-colors flex items-center gap-2" title="Cancel">
                            <i class="fa-solid fa-times text-sm"></i>
                            <span class="hidden md:inline text-sm font-semibold">Cancel</span>
                        </button>
                        <button id="back-to-list-btn-edit" class="lg:hidden p-2 text-stone-400 hover:text-white transition-colors ml-2" title="Close">
                            <i class="fa-solid fa-xmark text-lg"></i>
                        </button>
                    </div>
                </div>
                <div id="show-form" class="flex-1 overflow-y-auto p-6">
                    <!-- Edit form will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Shared Config Script -->
    <script src="setlist-builder.js"></script>

    <script>
        let shows = [];
        let clients = [];
        let selectedShowId = null;
        let hasUnsavedChanges = false;
        let originalShows = [];
        let setlists = [];
        let selectedYear = '';

        // Generate UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Load shows from GitHub
        async function loadShows() {
            try {
                const { owner, repo, token } = window.AppState.config;
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/content/shows.json`;

                const headers = {};
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                // Add timestamp to prevent caching
                const response = await fetch(`${url}?t=${Date.now()}`, { headers });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error("shows.json not found");
                    }
                    throw new Error(`GitHub Error: ${response.status}`);
                }

                const fileData = await response.json();
                // Decode base64 content from GitHub API
                const content = atob(fileData.content);
                shows = JSON.parse(content);

                // Ensure all shows have UUIDs
                shows = shows.map(show => {
                    if (!show.id) {
                        show.id = generateUUID();
                    }
                    return show;
                });

                originalShows = JSON.parse(JSON.stringify(shows));
                populateYearFilter();
                renderShowsList();
                updateShowCount();

                // Check for show parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const showId = urlParams.get('show');
                if (showId) {
                    selectShow(showId);
                }
            } catch (error) {
                console.error('Error loading shows:', error);
                alert(`Failed to load shows: ${error.message}`);
                // Initialize with empty array on error
                shows = [];
                originalShows = [];
                renderShowsList();
                updateShowCount();
            }
        }

        // Load clients from GitHub
        async function loadClients() {
            try {
                const { owner, repo, token } = window.AppState.config;
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/content/clients.json`;

                const headers = {};
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                // Add timestamp to prevent caching
                const response = await fetch(`${url}?t=${Date.now()}`, { headers });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error("clients.json not found");
                    }
                    throw new Error(`GitHub Error: ${response.status}`);
                }

                const fileData = await response.json();
                // Decode base64 content from GitHub API
                const content = atob(fileData.content);
                clients = JSON.parse(content);
            } catch (error) {
                console.error('Error loading clients:', error);
                // Initialize with empty array on error
                clients = [];
            }
        }

        // Load available setlists
        async function loadSetlists() {
            try {
                const setlistFiles = [
                    'Complete_Collection.json',
                    'DRAFT_Riverbillies1-17.json',
                    'NYE_ActionDetroit.json',
                    'Riverbillies1-17.json'
                ];
                setlists = setlistFiles.map(filename => ({
                    filename,
                    name: filename.replace('.json', '').replace(/_/g, ' ')
                }));
            } catch (error) {
                console.error('Error loading setlists:', error);
            }
        }

        // Populate year filter dropdown
        function populateYearFilter() {
            const years = new Set();
            shows.forEach(show => {
                const date = new Date(show.date);
                years.add(date.getFullYear());
            });

            const yearFilter = document.getElementById('year-filter');
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();

            yearFilter.innerHTML = '<option value="">All Years</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });

            // Default to current year if it exists in the list
            if (sortedYears.includes(currentYear)) {
                selectedYear = currentYear.toString();
                yearFilter.value = selectedYear;
            }
        }

        // Render shows list
        function renderShowsList(filter = '') {
            const container = document.getElementById('shows-list-container');
            const filteredShows = shows.filter(show => {
                const searchText = `${show.venue} ${show.city} ${show.state} ${show.date}`.toLowerCase();
                const matchesSearch = searchText.includes(filter.toLowerCase());

                // Year filter
                let matchesYear = true;
                if (selectedYear) {
                    const showDate = new Date(show.date);
                    matchesYear = showDate.getFullYear().toString() === selectedYear;
                }

                return matchesSearch && matchesYear;
            });

            container.innerHTML = filteredShows.map((show) => {
                const date = new Date(show.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const isSelected = selectedShowId === show.id;

                return `
                    <div class="show-item p-4 border-b border-stone-800 ${isSelected ? 'selected' : ''}" data-show-id="${show.id}">
                        <div class="font-bold text-white">${show.venue}</div>
                        <div class="text-sm text-stone-400">${show.city}, ${show.state}</div>
                        <div class="text-xs text-accent-teal mt-1">${formattedDate}</div>
                        ${show.isPrivate ? '<span class="text-xs bg-stone-700 px-2 py-1 rounded mt-1 inline-block">Private</span>' : ''}
                    </div>
                `;
            }).join('');

            // Update events counter
            const eventsCounter = document.getElementById('events-counter');
            eventsCounter.textContent = `${filteredShows.length} event${filteredShows.length !== 1 ? 's' : ''}`;

            // Add click handlers
            document.querySelectorAll('.show-item').forEach(item => {
                item.addEventListener('click', () => {
                    const showId = item.dataset.showId;
                    selectShow(showId);
                });
            });
        }

        // Select a show
        function selectShow(showId) {
            selectedShowId = showId;

            // Update URL with show parameter
            const url = new URL(window.location);
            url.searchParams.set('show', showId);
            window.history.pushState({}, '', url);

            renderShowsList(document.getElementById('search-shows').value);
            showViewMode();

            // On mobile/tablet, hide list and show editor
            if (window.innerWidth < 1024) {
                document.getElementById('shows-list').classList.add('hidden-mobile');
                document.getElementById('show-editor').classList.add('active-mobile');
            }
        }

        // Show view mode
        function showViewMode() {
            const show = shows.find(s => s.id === selectedShowId);
            if (!show) return;

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('show-view').classList.remove('hidden');
            document.getElementById('show-edit').classList.add('hidden');

            const date = new Date(show.date);
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Get client info
            let clientName = '<span class="text-stone-600">—</span>';
            let clientAddress = '<span class="text-stone-600">—</span>';
            if (show.clientId) {
                const client = clients.find(c => c.id === show.clientId);
                if (client) {
                    clientName = client.name;
                    if (client.address) {
                        clientAddress = `<a href="https://maps.google.com/?q=${encodeURIComponent(client.address)}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline">${client.address}</a>`;
                    }
                }
            }

            document.getElementById('show-title').textContent = show.venue;
            document.getElementById('show-details').innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Date</label>
                        <div class="text-lg text-white font-semibold">${formattedDate}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-stone-500 uppercase tracking-wide">Start Time</label>
                            <div class="text-lg text-white">${show.startTime || '<span class="text-stone-600">—</span>'}</div>
                        </div>
                        <div>
                            <label class="text-xs text-stone-500 uppercase tracking-wide">End Time</label>
                            <div class="text-lg text-white">${show.endTime || '<span class="text-stone-600">—</span>'}</div>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Client</label>
                        <div class="text-lg text-white">${clientName}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Address</label>
                        <div class="text-lg text-white">${clientAddress}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Location</label>
                        <div class="text-lg text-white">${show.city && show.state ? `${show.city}, ${show.state}` : '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Visibility</label>
                        <div class="text-lg text-white">${show.isPrivate ? 'Private Event' : 'Public Event'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Event Link</label>
                        <div class="text-lg">
                            ${show.eventLink ? `
                                <a href="${show.eventLink}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline flex items-center gap-2">
                                    View Event <i class="fa-solid fa-external-link text-sm"></i>
                                </a>
                            ` : '<span class="text-stone-600">—</span>'}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Setlist</label>
                        <div class="text-lg">
                            ${show.setlist ? `
                                <a href="setlist-viewer.html?setlist=${show.setlist}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline flex items-center gap-2">
                                    ${show.setlist.replace('.json', '').replace(/_/g, ' ')} <i class="fa-solid fa-external-link text-sm"></i>
                                </a>
                            ` : '<span class="text-stone-600">—</span>'}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Itinerary</label>
                        <div class="text-lg text-white whitespace-pre-wrap">${show.itinerary || '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Notes</label>
                        <div class="text-lg text-white whitespace-pre-wrap">${show.notes || '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Personnel</label>
                        <div class="text-lg text-white">${show.personnel && show.personnel.length > 0 ? show.personnel.join(', ') : '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Event Handler</label>
                        <div class="text-lg text-white">${show.eventHandler || '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Published on Website</label>
                        <div class="text-lg text-white">${show.published ? 'Yes - Visible on website' : 'No - Internal only'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Quote</label>
                        <div class="text-lg">
                            ${show.quoteId ? `
                                <a href="quote-generator.html?show=${show.id}&quote=${show.quoteId}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline flex items-center gap-2">
                                    View/Edit Quote <i class="fa-solid fa-external-link text-sm"></i>
                                </a>
                            ` : `
                                <a href="#" onclick="generateQuote(); return false;" class="text-accent-teal hover:underline flex items-center gap-2">
                                    Generate Quote <i class="fa-solid fa-plus text-sm"></i>
                                </a>
                            `}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Payout (Total)</label>
                        <div class="text-lg text-white font-semibold ${show.payout ? 'text-green-400' : ''}">${show.payout ? `$${show.payout}` : '<span class="text-stone-600 font-normal">—</span>'}</div>
                    </div>
                </div>
            `;
        }

        // Show edit mode
        function showEditMode() {
            const show = shows.find(s => s.id === selectedShowId);
            if (!show) return;

            document.getElementById('show-view').classList.add('hidden');
            document.getElementById('show-edit').classList.remove('hidden');

            // Convert date to YYYY-MM-DD format for input
            const dateParts = show.date.split('/');
            const formattedDate = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;

            document.getElementById('show-form').innerHTML = `
                <div class="space-y-4 max-w-2xl">
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Venue Name</label>
                        <input type="text" id="edit-venue" value="${show.venue}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Client</label>
                        <select id="edit-client" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                            <option value="">Select client</option>
                            ${clients.map(client => `<option value="${client.id}" ${show.clientId === client.id ? 'selected' : ''}>${client.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">City</label>
                            <input type="text" id="edit-city" value="${show.city}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">State</label>
                            <input type="text" id="edit-state" value="${show.state}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Date</label>
                        <input type="date" id="edit-date" value="${formattedDate}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">Start Time</label>
                            <input type="text" id="edit-start-time" value="${show.startTime}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="8:00 PM">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">End Time</label>
                            <input type="text" id="edit-end-time" value="${show.endTime}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="11:00 PM">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Event Link (optional)</label>
                        <input type="url" id="edit-event-link" value="${show.eventLink || ''}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Setlist (optional)</label>
                        <select id="edit-setlist" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                            <option value="">No setlist</option>
                            ${setlists.map(sl => `<option value="${sl.filename}" ${show.setlist === sl.filename ? 'selected' : ''}>${sl.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Itinerary (optional)</label>
                        <textarea id="edit-itinerary" rows="4" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal resize-y" placeholder="Load-in: 5:00 PM&#10;Soundcheck: 5:30 PM&#10;Doors: 7:00 PM&#10;Performance: 8:00 PM - 11:00 PM">${show.itinerary || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Notes (optional)</label>
                        <textarea id="edit-notes" rows="4" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal resize-y" placeholder="Internal notes about this show...">${show.notes || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-3">Personnel Assignment</label>
                        <div class="space-y-2">
                            ${['Anthony', 'Tom', 'Lester', 'David', 'Shelley', 'Kelsey'].map(member => `
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" class="personnel-checkbox w-4 h-4 text-accent-teal bg-stone-800 border-stone-700 rounded focus:ring-accent-teal focus:ring-2 cursor-pointer" value="${member}" ${show.personnel && show.personnel.includes(member) ? 'checked' : ''}>
                                    <span class="text-sm text-stone-300">${member}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Event Handler (optional)</label>
                        <select id="edit-event-handler" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                            <option value="">Select event handler</option>
                            ${['Anthony', 'Tom', 'Lester', 'David', 'Shelley', 'Kelsey'].map(member => `<option value="${member}" ${show.eventHandler === member ? 'selected' : ''}>${member}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Base Musician Payout (Total)</label>
                        <div class="flex items-center gap-2">
                            <span class="text-stone-400">$</span>
                            <input type="number" id="edit-payout" value="${show.payout || ''}" min="0" step="1" class="flex-1 px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="e.g., 1000">
                        </div>
                        <p class="text-xs text-stone-500 mt-2">
                            Total expected payout from the event (base musician payout before add-ons)
                        </p>
                    </div>
                    <div class="flex gap-6">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="edit-is-private" ${show.isPrivate ? 'checked' : ''} class="w-5 h-5 text-accent-teal bg-stone-800 border-stone-700 rounded focus:ring-accent-teal focus:ring-2 cursor-pointer">
                            <span class="text-sm font-semibold text-stone-300">Private Event</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="edit-published" ${show.published ? 'checked' : ''} class="w-5 h-5 text-accent-teal bg-stone-800 border-stone-700 rounded focus:ring-accent-teal focus:ring-2 cursor-pointer">
                            <span class="text-sm font-semibold text-stone-300">Published on Website</span>
                        </label>
                    </div>
                </div>
            `;
        }

        // Save edited show
        function saveEdit() {
            const show = shows.find(s => s.id === selectedShowId);
            if (!show) return;

            const dateInput = document.getElementById('edit-date').value;
            const dateParts = dateInput.split('-');
            const formattedDate = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;

            const setlistValue = document.getElementById('edit-setlist').value;
            const itineraryValue = document.getElementById('edit-itinerary').value.trim();
            const notesValue = document.getElementById('edit-notes').value.trim();
            const eventHandlerValue = document.getElementById('edit-event-handler').value;
            const clientValue = document.getElementById('edit-client').value;
            const payoutValue = document.getElementById('edit-payout').value.trim();

            // Get selected personnel
            const personnelCheckboxes = document.querySelectorAll('.personnel-checkbox:checked');
            const personnel = Array.from(personnelCheckboxes).map(cb => cb.value);

            // Update the show object
            show.date = formattedDate;
            show.venue = document.getElementById('edit-venue').value;
            show.city = document.getElementById('edit-city').value;
            show.state = document.getElementById('edit-state').value;
            show.startTime = document.getElementById('edit-start-time').value;
            show.endTime = document.getElementById('edit-end-time').value;
            show.isPrivate = document.getElementById('edit-is-private').checked;
            show.published = document.getElementById('edit-published').checked;
            show.eventLink = document.getElementById('edit-event-link').value || undefined;
            show.setlist = setlistValue || undefined;
            show.itinerary = itineraryValue || undefined;
            show.notes = notesValue || undefined;
            show.personnel = personnel.length > 0 ? personnel : undefined;
            show.eventHandler = eventHandlerValue || undefined;
            show.clientId = clientValue || undefined;
            show.payout = payoutValue ? parseInt(payoutValue) : undefined;

            hasUnsavedChanges = true;
            showSaveButton();
            renderShowsList(document.getElementById('search-shows').value);
            showViewMode();
        }

        // Add new show
        function addNewShow() {
            const newShow = {
                id: generateUUID(),
                date: new Date().toLocaleDateString('en-US'),
                venue: "New Venue",
                city: "City",
                state: "MI",
                startTime: "8:00 PM",
                endTime: "11:00 PM",
                isPrivate: false,
                published: false,
                clientId: undefined
            };

            shows.unshift(newShow);
            hasUnsavedChanges = true;
            showSaveButton();
            renderShowsList();
            updateShowCount();
            selectShow(newShow.id);
            showEditMode();
        }

        // Generate quote for show
        function generateQuote() {
            const show = shows.find(s => s.id === selectedShowId);
            if (!show) return;

            window.open(`quote-generator.html?show=${show.id}&new=true`, '_blank');
        }

        // Download calendar event as .ics file
        function downloadCalendarEvent() {
            const show = shows.find(s => s.id === selectedShowId);
            if (!show) return;

            // Get client info for address
            let location = '';
            let clientName = '';
            if (show.clientId) {
                const client = clients.find(c => c.id === show.clientId);
                if (client) {
                    clientName = client.name;
                    if (client.address) {
                        location = client.address;
                    }
                }
            }
            // Fallback to city/state if no address
            if (!location && show.city && show.state) {
                location = `${show.city}, ${show.state}`;
            }

            // Parse date and times
            const dateParts = show.date.split('/');
            const month = dateParts[0].padStart(2, '0');
            const day = dateParts[1].padStart(2, '0');
            const year = dateParts[2];

            // Parse time strings like "8:00 PM" to 24hr format
            function parseTime(timeStr) {
                if (!timeStr) return null;
                const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (!match) return null;
                let hours = parseInt(match[1]);
                const minutes = match[2];
                const period = match[3]?.toUpperCase();
                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;
                return `${hours.toString().padStart(2, '0')}${minutes}00`;
            }

            const startTime = parseTime(show.startTime) || '200000';
            const endTime = parseTime(show.endTime) || '230000';

            // Format dates for ICS (YYYYMMDDTHHMMSS)
            const dtStart = `${year}${month}${day}T${startTime}`;
            const dtEnd = `${year}${month}${day}T${endTime}`;
            const dtStamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            // Build description
            const showManagerUrl = `${window.location.origin}/admin/show-manager.html?show=${show.id}`;
            let description = `Ultraphonics @ ${show.venue}`;
            description += `\\n\\nShow Details: ${showManagerUrl}`;
            if (clientName) description += `\\n\\nClient: ${clientName}`;
            if (show.startTime) description += `\\nStart: ${show.startTime}`;
            if (show.endTime) description += `\\nEnd: ${show.endTime}`;
            if (show.itinerary) description += `\\n\\nItinerary:\\n${show.itinerary.replace(/\n/g, '\\n')}`;
            if (show.notes) description += `\\n\\nNotes:\\n${show.notes.replace(/\n/g, '\\n')}`;
            if (show.personnel && show.personnel.length > 0) description += `\\n\\nPersonnel: ${show.personnel.join(', ')}`;
            if (show.eventHandler) description += `\\nEvent Handler: ${show.eventHandler}`;
            if (show.eventLink) description += `\\n\\nEvent Link: ${show.eventLink}`;

            // Create ICS content
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Ultraphonics//Show Manager//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'BEGIN:VEVENT',
                `UID:${show.id}@ultraphonicsmusic.com`,
                `DTSTAMP:${dtStamp}`,
                `DTSTART:${dtStart}`,
                `DTEND:${dtEnd}`,
                `SUMMARY:Ultraphonics @ ${show.venue}`,
                `DESCRIPTION:${description}`,
                location ? `LOCATION:${location}` : '',
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(line => line).join('\r\n');

            // Download the file
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ultraphonics_${show.venue.replace(/\s+/g, '_')}_${year}${month}${day}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Back to list on mobile/tablet
        function backToList() {
            if (window.innerWidth < 1024) {
                document.getElementById('shows-list').classList.remove('hidden-mobile');
                document.getElementById('show-editor').classList.remove('active-mobile');
            }
        }

        // Delete show
        function deleteShow() {
            if (!confirm('Are you sure you want to delete this show?')) return;

            const showIndex = shows.findIndex(s => s.id === selectedShowId);
            if (showIndex !== -1) {
                shows.splice(showIndex, 1);
            }

            selectedShowId = null;

            // Remove show parameter from URL
            const url = new URL(window.location);
            url.searchParams.delete('show');
            window.history.pushState({}, '', url);

            hasUnsavedChanges = true;
            showSaveButton();
            renderShowsList();
            updateShowCount();

            document.getElementById('show-view').classList.add('hidden');
            document.getElementById('show-edit').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }

        // Save to GitHub
        async function saveToGitHub() {
            const { owner, repo, token } = window.AppState.config;
            if (!token) {
                alert('Please configure your GitHub token in Settings first.');
                window.open('setlist-builder.html', '_blank');
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            try {
                // Ensure all shows have UUIDs before saving
                shows.forEach(show => {
                    if (!show.id) {
                        show.id = generateUUID();
                    }
                });

                const path = 'content/shows.json';
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

                // Get current file SHA
                let sha = null;
                try {
                    const getResponse = await fetch(apiUrl, {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    if (getResponse.ok) {
                        sha = (await getResponse.json()).sha;
                    }
                } catch (e) {
                    console.warn('Could not fetch existing SHA:', e);
                }

                // Encode content as base64
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(shows, null, 2))));

                // Update file
                const updateResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update shows from Show Manager\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>`,
                        content: content,
                        sha: sha,
                        branch: 'main'
                    })
                });

                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || `GitHub Error: ${updateResponse.status}`);
                }

                originalShows = JSON.parse(JSON.stringify(shows));
                hasUnsavedChanges = false;
                hideSaveButton();

                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Changes';
                }, 2000);

            } catch (error) {
                console.error('Error saving to GitHub:', error);
                alert(`Failed to save shows to GitHub: ${error.message}`);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Changes';
            }
        }

        // UI Helpers
        function showSaveButton() {
            document.getElementById('save-btn').classList.remove('hidden');
        }

        function hideSaveButton() {
            document.getElementById('save-btn').classList.add('hidden');
        }

        function updateShowCount() {
            let count = shows.length;
            if (selectedYear) {
                count = shows.filter(show => {
                    const showDate = new Date(show.date);
                    return showDate.getFullYear().toString() === selectedYear;
                }).length;
            }
            document.getElementById('show-count').textContent = `${count} show${count !== 1 ? 's' : ''}`;
        }

        // Event Listeners
        document.getElementById('search-shows').addEventListener('input', (e) => {
            renderShowsList(e.target.value);
        });

        document.getElementById('year-filter').addEventListener('change', (e) => {
            selectedYear = e.target.value;
            renderShowsList(document.getElementById('search-shows').value);
            updateShowCount();
        });

        document.getElementById('edit-btn').addEventListener('click', showEditMode);
        document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
        document.getElementById('cancel-edit-btn').addEventListener('click', showViewMode);
        document.getElementById('delete-btn').addEventListener('click', deleteShow);
        document.getElementById('add-show-btn').addEventListener('click', addNewShow);
        document.getElementById('save-btn').addEventListener('click', saveToGitHub);
        document.getElementById('download-cal-btn').addEventListener('click', downloadCalendarEvent);
        document.getElementById('back-to-list-btn').addEventListener('click', backToList);
        document.getElementById('back-to-list-btn-edit').addEventListener('click', backToList);

        // Settings modal handlers
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const clearCacheBtn = document.getElementById('clear-cache-btn');

        function openSettingsModal() {
            // Load current config
            const ghToken = document.getElementById('settings-gh-token');
            ghToken.value = window.AppState.config.token || '';
            settingsModal.classList.remove('hidden');
        }

        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
        }

        function updateConnectionStatus(isConnected) {
            const statusEl = document.getElementById('connection-status');
            const labelEl = document.getElementById('connection-label');
            const indicator = statusEl.querySelector('i');

            if (isConnected) {
                labelEl.textContent = 'Connected';
                statusEl.classList.remove('text-stone-400');
                statusEl.classList.add('text-green-400');
                indicator.classList.remove('text-stone-500');
                indicator.classList.add('text-green-400');
            } else {
                labelEl.textContent = 'Read Only';
                statusEl.classList.remove('text-green-400');
                statusEl.classList.add('text-stone-400');
                indicator.classList.remove('text-green-400');
                indicator.classList.add('text-stone-500');
            }
        }

        function saveSettingsModal() {
            const token = document.getElementById('settings-gh-token').value.trim();
            window.AppState.config.token = token;
            if (!window.AppState.config.owner) window.AppState.config.owner = 'tdhckmn';
            if (!window.AppState.config.repo) window.AppState.config.repo = 'ultraphonics-web';
            if (!window.AppState.config.folder) window.AppState.config.folder = 'content/setlists';
            localStorage.setItem('up_gh_config', JSON.stringify(window.AppState.config));
            closeSettingsModal();
            updateConnectionStatus(!!token);
        }

        function clearCacheAndReload() {
            const url = new URL(window.location);
            url.searchParams.set('cachebust', Date.now());
            window.location.href = url.toString();
        }

        settingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        saveSettingsBtn.addEventListener('click', saveSettingsModal);
        clearCacheBtn.addEventListener('click', clearCacheAndReload);

        // Close modal on backdrop click
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettingsModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !settingsModal.classList.contains('hidden')) {
                closeSettingsModal();
            }
        });

        // Initialize
        loadConfig(); // Load GitHub config from localStorage
        updateConnectionStatus(!!window.AppState.config.token);
        loadSetlists();
        loadClients();
        loadShows();
    </script>

</body>
</html>
