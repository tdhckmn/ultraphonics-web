<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Show Manager - Ultraphonics</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/Ultraphonics-Spiral-512.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- Google Fonts - Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Apply Montserrat font globally, but exclude Font Awesome icons */
        body, button, input, select, textarea, h1, h2, h3, h4, h5, h6, p, a, span:not([class*="fa-"]), div:not([class*="fa-"]) {
            font-family: 'Montserrat', sans-serif !important;
        }

        /* Manager Layout */
        .manager-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 1fr;
            gap: 1.5rem;
            height: calc(100vh - 70px);
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .manager-container {
                display: flex;
                flex-direction: column;
                padding: 0.5rem;
                height: calc(100vh - 70px);
                overflow: hidden;
            }
            #shows-list {
                flex: 1;
                display: flex;
            }
            #shows-list.hidden-mobile {
                display: none !important;
            }
            #show-editor {
                flex: 1;
                position: absolute;
                top: 70px;
                left: 0;
                right: 0;
                bottom: 0;
                display: none;
            }
            #show-editor.active-mobile {
                display: flex !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1023px) {
            .manager-container {
                display: flex;
                flex-direction: column;
                padding: 0.5rem;
                height: auto;
                min-height: calc(100vh - 70px);
            }
            #shows-list {
                max-height: 400px;
                min-height: 300px;
            }
            #show-editor {
                flex: 1;
                min-height: 500px;
            }
        }

        /* Show List Styles */
        .show-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .show-item:hover {
            background: rgba(20, 184, 166, 0.1);
        }

        .show-item.selected {
            background: rgba(20, 184, 166, 0.2);
            border-left: 3px solid #14b8a6;
        }

        /* Teal theme colors */
        .bg-accent-teal {
            background-color: #14b8a6;
        }

        .text-accent-teal {
            color: #14b8a6;
        }

        .border-accent-teal {
            border-color: #14b8a6;
        }

        .hover\:bg-accent-teal:hover {
            background-color: #14b8a6;
        }
    </style>
</head>
<body class="bg-stone-950 text-stone-100 h-full overflow-hidden">

    <!-- Top Bar -->
    <div class="bg-stone-900 border-b border-stone-800 px-6 py-4 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-3 flex-wrap">
            <a href="index.html" class="text-stone-400 hover:text-white transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1 class="text-xl font-bold text-white">Show Manager</h1>
            <span class="text-sm text-stone-500" id="show-count">0 shows</span>
            <select id="year-filter" class="px-3 py-1.5 bg-stone-800 border border-stone-700 rounded-lg text-white text-sm focus:outline-none focus:border-accent-teal">
                <option value="">All Years</option>
            </select>
        </div>
        <div class="flex items-center gap-3">
            <button id="add-show-btn" class="px-4 py-2 bg-accent-teal text-white rounded-lg font-semibold hover:bg-teal-600 transition-colors flex items-center gap-2">
                <i class="fa-solid fa-plus"></i>
                Add Show
            </button>
            <button id="save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-500 transition-colors hidden flex items-center gap-2">
                <i class="fa-solid fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="manager-container">
        <!-- Left Sidebar: Shows List -->
        <div id="shows-list" class="bg-stone-900 rounded-xl border border-stone-800 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-stone-800">
                <input type="text" id="search-shows" placeholder="Search shows..." class="w-full px-4 py-2 bg-stone-800 border border-stone-700 rounded-lg text-white placeholder-stone-500 focus:outline-none focus:border-accent-teal">
            </div>
            <div id="shows-list-container" class="flex-1 overflow-y-auto">
                <!-- Shows will be populated here -->
            </div>
        </div>

        <!-- Right: Show Editor -->
        <div id="show-editor" class="bg-stone-900 rounded-xl border border-stone-800 overflow-hidden flex flex-col">
            <div id="empty-state" class="flex-1 flex items-center justify-center text-stone-500">
                <div class="text-center">
                    <i class="fa-solid fa-calendar-days text-6xl mb-4 opacity-20"></i>
                    <p class="text-lg">Select a show to view or edit</p>
                </div>
            </div>

            <div id="show-view" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-stone-800 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <button id="back-to-list-btn" class="md:hidden text-stone-400 hover:text-white transition-colors">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-white" id="show-title">Show Details</h2>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button id="generate-quote-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-500 transition-colors flex items-center gap-2 hidden">
                            <i class="fa-solid fa-file-invoice-dollar"></i>
                            Generate Quote
                        </button>
                        <button id="edit-btn" class="px-4 py-2 bg-accent-teal text-white rounded-lg font-semibold hover:bg-teal-600 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-pen"></i>
                            Edit
                        </button>
                        <button id="delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-500 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
                <div id="show-details" class="flex-1 overflow-y-auto p-6">
                    <!-- View mode content -->
                </div>
            </div>

            <div id="show-edit" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-stone-800 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <button id="back-to-list-btn-edit" class="md:hidden text-stone-400 hover:text-white transition-colors">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-white">Edit Show</h2>
                    </div>
                    <div class="flex gap-2">
                        <button id="save-edit-btn" class="px-4 py-2 bg-accent-teal text-white rounded-lg font-semibold hover:bg-teal-600 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-check"></i>
                            Save
                        </button>
                        <button id="cancel-edit-btn" class="px-4 py-2 bg-stone-700 text-white rounded-lg font-semibold hover:bg-stone-600 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>
                <div id="show-form" class="flex-1 overflow-y-auto p-6">
                    <!-- Edit form will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let shows = [];
        let selectedShowIndex = null;
        let hasUnsavedChanges = false;
        let originalShows = [];
        let setlists = [];
        let selectedYear = '';

        // Load shows from GitHub
        async function loadShows() {
            try {
                const response = await fetch('/content/shows.json');
                shows = await response.json();
                originalShows = JSON.parse(JSON.stringify(shows));
                populateYearFilter();
                renderShowsList();
                updateShowCount();
            } catch (error) {
                console.error('Error loading shows:', error);
                alert('Failed to load shows');
            }
        }

        // Load available setlists
        async function loadSetlists() {
            try {
                const setlistFiles = [
                    'Complete_Collection.json',
                    'DRAFT_Riverbillies1-17.json',
                    'NYE_ActionDetroit.json',
                    'Riverbillies1-17.json'
                ];
                setlists = setlistFiles.map(filename => ({
                    filename,
                    name: filename.replace('.json', '').replace(/_/g, ' ')
                }));
            } catch (error) {
                console.error('Error loading setlists:', error);
            }
        }

        // Populate year filter dropdown
        function populateYearFilter() {
            const years = new Set();
            shows.forEach(show => {
                const date = new Date(show.date);
                years.add(date.getFullYear());
            });

            const yearFilter = document.getElementById('year-filter');
            const sortedYears = Array.from(years).sort((a, b) => b - a);

            yearFilter.innerHTML = '<option value="">All Years</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        // Render shows list
        function renderShowsList(filter = '') {
            const container = document.getElementById('shows-list-container');
            const filteredShows = shows.filter(show => {
                const searchText = `${show.venue} ${show.city} ${show.state} ${show.date}`.toLowerCase();
                const matchesSearch = searchText.includes(filter.toLowerCase());

                // Year filter
                let matchesYear = true;
                if (selectedYear) {
                    const showDate = new Date(show.date);
                    matchesYear = showDate.getFullYear().toString() === selectedYear;
                }

                return matchesSearch && matchesYear;
            });

            container.innerHTML = filteredShows.map((show, index) => {
                const actualIndex = shows.findIndex(s => s === show);
                const date = new Date(show.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const isSelected = selectedShowIndex === actualIndex;

                return `
                    <div class="show-item p-4 border-b border-stone-800 ${isSelected ? 'selected' : ''}" data-index="${actualIndex}">
                        <div class="font-bold text-white">${show.venue}</div>
                        <div class="text-sm text-stone-400">${show.city}, ${show.state}</div>
                        <div class="text-xs text-accent-teal mt-1">${formattedDate}</div>
                        ${show.isPrivate ? '<span class="text-xs bg-stone-700 px-2 py-1 rounded mt-1 inline-block">Private</span>' : ''}
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.show-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectShow(index);
                });
            });
        }

        // Select a show
        function selectShow(index) {
            selectedShowIndex = index;
            renderShowsList(document.getElementById('search-shows').value);
            showViewMode();

            // On mobile, hide list and show editor
            if (window.innerWidth <= 768) {
                document.getElementById('shows-list').classList.add('hidden-mobile');
                document.getElementById('show-editor').classList.add('active-mobile');
            }
        }

        // Show view mode
        function showViewMode() {
            const show = shows[selectedShowIndex];
            if (!show) return;

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('show-view').classList.remove('hidden');
            document.getElementById('show-edit').classList.add('hidden');

            // Show/hide generate quote button
            const generateQuoteBtn = document.getElementById('generate-quote-btn');
            if (show.quote) {
                generateQuoteBtn.classList.add('hidden');
            } else {
                generateQuoteBtn.classList.remove('hidden');
            }

            const date = new Date(show.date);
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            document.getElementById('show-title').textContent = show.venue;
            document.getElementById('show-details').innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Date</label>
                        <div class="text-lg text-white font-semibold">${formattedDate}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-stone-500 uppercase tracking-wide">Start Time</label>
                            <div class="text-lg text-white">${show.startTime || '<span class="text-stone-600">—</span>'}</div>
                        </div>
                        <div>
                            <label class="text-xs text-stone-500 uppercase tracking-wide">End Time</label>
                            <div class="text-lg text-white">${show.endTime || '<span class="text-stone-600">—</span>'}</div>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Location</label>
                        <div class="text-lg text-white">${show.city && show.state ? `${show.city}, ${show.state}` : '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Visibility</label>
                        <div class="text-lg text-white">${show.isPrivate ? 'Private Event' : 'Public Event'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Event Link</label>
                        <div class="text-lg">
                            ${show.eventLink ? `
                                <a href="${show.eventLink}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline flex items-center gap-2">
                                    View Event <i class="fa-solid fa-external-link text-sm"></i>
                                </a>
                            ` : '<span class="text-stone-600">—</span>'}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Setlist</label>
                        <div class="text-lg">
                            ${show.setlist ? `
                                <a href="setlist-viewer.html?setlist=${show.setlist}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline flex items-center gap-2">
                                    ${show.setlist.replace('.json', '').replace(/_/g, ' ')} <i class="fa-solid fa-external-link text-sm"></i>
                                </a>
                            ` : '<span class="text-stone-600">—</span>'}
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Itinerary</label>
                        <div class="text-lg text-white whitespace-pre-wrap">${show.itinerary || '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Notes</label>
                        <div class="text-lg text-white whitespace-pre-wrap">${show.notes || '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Personnel</label>
                        <div class="text-lg text-white">${show.personnel && show.personnel.length > 0 ? show.personnel.join(', ') : '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Event Handler</label>
                        <div class="text-lg text-white">${show.eventHandler || '<span class="text-stone-600">—</span>'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Published on Website</label>
                        <div class="text-lg text-white">${show.published ? 'Yes - Visible on website' : 'No - Internal only'}</div>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 uppercase tracking-wide">Quote</label>
                        <div class="text-lg">
                            ${show.quote ? `
                                <a href="quote-generator.html?show=${selectedShowIndex}&quote=${show.quote}" target="_blank" rel="noopener noreferrer" class="text-accent-teal hover:underline flex items-center gap-2">
                                    View/Edit Quote <i class="fa-solid fa-external-link text-sm"></i>
                                </a>
                            ` : '<span class="text-stone-600">—</span>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Show edit mode
        function showEditMode() {
            const show = shows[selectedShowIndex];
            if (!show) return;

            document.getElementById('show-view').classList.add('hidden');
            document.getElementById('show-edit').classList.remove('hidden');

            // Convert date to YYYY-MM-DD format for input
            const dateParts = show.date.split('/');
            const formattedDate = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;

            document.getElementById('show-form').innerHTML = `
                <div class="space-y-4 max-w-2xl">
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Venue Name</label>
                        <input type="text" id="edit-venue" value="${show.venue}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">City</label>
                            <input type="text" id="edit-city" value="${show.city}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">State</label>
                            <input type="text" id="edit-state" value="${show.state}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Date</label>
                        <input type="date" id="edit-date" value="${formattedDate}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">Start Time</label>
                            <input type="text" id="edit-start-time" value="${show.startTime}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="8:00 PM">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-stone-300 mb-2">End Time</label>
                            <input type="text" id="edit-end-time" value="${show.endTime}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="11:00 PM">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Event Link (optional)</label>
                        <input type="url" id="edit-event-link" value="${show.eventLink || ''}" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal" placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Setlist (optional)</label>
                        <select id="edit-setlist" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                            <option value="">No setlist</option>
                            ${setlists.map(sl => `<option value="${sl.filename}" ${show.setlist === sl.filename ? 'selected' : ''}>${sl.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Itinerary (optional)</label>
                        <textarea id="edit-itinerary" rows="4" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal resize-y" placeholder="Load-in: 5:00 PM&#10;Soundcheck: 5:30 PM&#10;Doors: 7:00 PM&#10;Performance: 8:00 PM - 11:00 PM">${show.itinerary || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Notes (optional)</label>
                        <textarea id="edit-notes" rows="4" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal resize-y" placeholder="Internal notes about this show...">${show.notes || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-3">Personnel Assignment</label>
                        <div class="space-y-2">
                            ${['Anthony', 'Tom', 'Lester', 'David', 'Shelley', 'Kelsey'].map(member => `
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" class="personnel-checkbox w-4 h-4 text-accent-teal bg-stone-800 border-stone-700 rounded focus:ring-accent-teal focus:ring-2 cursor-pointer" value="${member}" ${show.personnel && show.personnel.includes(member) ? 'checked' : ''}>
                                    <span class="text-sm text-stone-300">${member}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-stone-300 mb-2">Event Handler (optional)</label>
                        <select id="edit-event-handler" class="w-full px-4 py-3 bg-stone-800 border border-stone-700 rounded-lg text-white focus:outline-none focus:border-accent-teal">
                            <option value="">Select event handler</option>
                            ${['Anthony', 'Tom', 'Lester', 'David', 'Shelley', 'Kelsey'].map(member => `<option value="${member}" ${show.eventHandler === member ? 'selected' : ''}>${member}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex gap-6">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="edit-is-private" ${show.isPrivate ? 'checked' : ''} class="w-5 h-5 text-accent-teal bg-stone-800 border-stone-700 rounded focus:ring-accent-teal focus:ring-2 cursor-pointer">
                            <span class="text-sm font-semibold text-stone-300">Private Event</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="edit-published" ${show.published ? 'checked' : ''} class="w-5 h-5 text-accent-teal bg-stone-800 border-stone-700 rounded focus:ring-accent-teal focus:ring-2 cursor-pointer">
                            <span class="text-sm font-semibold text-stone-300">Published on Website</span>
                        </label>
                    </div>
                </div>
            `;
        }

        // Save edited show
        function saveEdit() {
            const dateInput = document.getElementById('edit-date').value;
            const dateParts = dateInput.split('-');
            const formattedDate = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;

            const setlistValue = document.getElementById('edit-setlist').value;
            const itineraryValue = document.getElementById('edit-itinerary').value.trim();
            const notesValue = document.getElementById('edit-notes').value.trim();
            const eventHandlerValue = document.getElementById('edit-event-handler').value;

            // Get selected personnel
            const personnelCheckboxes = document.querySelectorAll('.personnel-checkbox:checked');
            const personnel = Array.from(personnelCheckboxes).map(cb => cb.value);

            shows[selectedShowIndex] = {
                date: formattedDate,
                venue: document.getElementById('edit-venue').value,
                city: document.getElementById('edit-city').value,
                state: document.getElementById('edit-state').value,
                startTime: document.getElementById('edit-start-time').value,
                endTime: document.getElementById('edit-end-time').value,
                isPrivate: document.getElementById('edit-is-private').checked,
                published: document.getElementById('edit-published').checked,
                eventLink: document.getElementById('edit-event-link').value || undefined,
                setlist: setlistValue || undefined,
                itinerary: itineraryValue || undefined,
                notes: notesValue || undefined,
                personnel: personnel.length > 0 ? personnel : undefined,
                eventHandler: eventHandlerValue || undefined,
                quote: shows[selectedShowIndex].quote || undefined
            };

            hasUnsavedChanges = true;
            showSaveButton();
            renderShowsList(document.getElementById('search-shows').value);
            showViewMode();
        }

        // Add new show
        function addNewShow() {
            const newShow = {
                date: new Date().toLocaleDateString('en-US'),
                venue: "New Venue",
                city: "City",
                state: "MI",
                startTime: "8:00 PM",
                endTime: "11:00 PM",
                isPrivate: false,
                published: false
            };

            shows.unshift(newShow);
            hasUnsavedChanges = true;
            showSaveButton();
            renderShowsList();
            updateShowCount();
            selectShow(0);
            showEditMode();
        }

        // Generate quote for show
        function generateQuote() {
            const show = shows[selectedShowIndex];
            if (!show) return;

            // Create quote ID based on venue and date
            const quoteId = `${show.venue.replace(/\s+/g, '_')}_${show.date.replace(/\//g, '-')}`;
            window.open(`quote-generator.html?show=${selectedShowIndex}&new=true`, '_blank');
        }

        // Back to list on mobile
        function backToList() {
            if (window.innerWidth <= 768) {
                document.getElementById('shows-list').classList.remove('hidden-mobile');
                document.getElementById('show-editor').classList.remove('active-mobile');
            }
        }

        // Delete show
        function deleteShow() {
            if (!confirm('Are you sure you want to delete this show?')) return;

            shows.splice(selectedShowIndex, 1);
            selectedShowIndex = null;
            hasUnsavedChanges = true;
            showSaveButton();
            renderShowsList();
            updateShowCount();

            document.getElementById('show-view').classList.add('hidden');
            document.getElementById('show-edit').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }

        // Save to GitHub
        async function saveToGitHub() {
            const config = JSON.parse(localStorage.getItem('up_gh_config') || '{}');
            if (!config.token) {
                alert('Please configure your GitHub token in the admin settings first.');
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            try {
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/content/shows.json`, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                const fileData = await getResponse.json();
                const sha = fileData.sha;

                // Update file
                const content = btoa(JSON.stringify(shows, null, 2));
                const updateResponse = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/content/shows.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update shows from Show Manager\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>`,
                        content: content,
                        sha: sha
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to save to GitHub');
                }

                originalShows = JSON.parse(JSON.stringify(shows));
                hasUnsavedChanges = false;
                hideSaveButton();

                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Changes';
                }, 2000);

            } catch (error) {
                console.error('Error saving to GitHub:', error);
                alert('Failed to save shows to GitHub. Please check your token and try again.');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Changes';
            }
        }

        // UI Helpers
        function showSaveButton() {
            document.getElementById('save-btn').classList.remove('hidden');
        }

        function hideSaveButton() {
            document.getElementById('save-btn').classList.add('hidden');
        }

        function updateShowCount() {
            document.getElementById('show-count').textContent = `${shows.length} show${shows.length !== 1 ? 's' : ''}`;
        }

        // Event Listeners
        document.getElementById('search-shows').addEventListener('input', (e) => {
            renderShowsList(e.target.value);
        });

        document.getElementById('year-filter').addEventListener('change', (e) => {
            selectedYear = e.target.value;
            renderShowsList(document.getElementById('search-shows').value);
        });

        document.getElementById('edit-btn').addEventListener('click', showEditMode);
        document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
        document.getElementById('cancel-edit-btn').addEventListener('click', showViewMode);
        document.getElementById('delete-btn').addEventListener('click', deleteShow);
        document.getElementById('add-show-btn').addEventListener('click', addNewShow);
        document.getElementById('save-btn').addEventListener('click', saveToGitHub);
        document.getElementById('generate-quote-btn').addEventListener('click', generateQuote);
        document.getElementById('back-to-list-btn').addEventListener('click', backToList);
        document.getElementById('back-to-list-btn-edit').addEventListener('click', backToList);

        // Initialize
        loadSetlists();
        loadShows();
    </script>

</body>
</html>
